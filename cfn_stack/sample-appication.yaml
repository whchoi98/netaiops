AWSTemplateFormatVersion: '2010-09-09'
# ============================================================================
# NetAIOps 샘플 애플리케이션 인프라
# 이 템플릿은 이미지 공유 샘플 애플리케이션의 전체 인프라를 배포합니다.
# 포함 리소스: VPC, EC2, RDS, Lambda, API Gateway, S3 등
# 배포 순서: 1단계 (기본 인프라) - 다른 스택들의 의존성 대상
# ============================================================================
Description: 'Enhanced ExampleCorp Image Sharing Sample Application - Implementing Required Flow:
  1. User clicks like/share User Interaction Lambda Database update
  2. User refreshes HTML Rendering Lambda -> Database query -> Updated counts displayed  
  3. User clicks Reports tab -> HTML Rendering Lambda -> Reporting server -> Database Analytics displayed
  4. Reporting server -> Direct database query -> Local analytics dashboard'

Parameters:
  DBUsername:
    Type: String
    Default: admin
    Description: Database administrator username
    
  DBPassword:
    Type: String
    NoEcho: true
    MinLength: 8
    Default: ReInvent2025!
    Description: Database administrator password
    
Resources:
  # ==========================================
  # 이미지 콘텐츠용 S3 버킷
  # S3 BUCKET FOR IMAGE CONTENT
  # ==========================================
  ImageBucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Delete
    Properties:
      BucketName: !Sub "netaiops-img-${AWS::AccountId}-${AWS::Region}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, HEAD]
            AllowedOrigins: ['*']
            MaxAge: 3600

  ImageBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ImageBucket
      PolicyDocument:
        Statement:
          - Sid: AllowLambdaAccess
            Effect: Allow
            Principal:
              AWS: !GetAtt LambdaExecutionRole.Arn
            Action: 
              - s3:GetObject
              - s3:PutObject
              - s3:DeleteObject
            Resource: !Sub "arn:aws:s3:::${ImageBucket}/*"
          - Sid: AllowLambdaListBucket
            Effect: Allow
            Principal:
              AWS: !GetAtt LambdaExecutionRole.Arn
            Action: 
              - s3:ListBucket
            Resource: !Sub "arn:aws:s3:::${ImageBucket}"

  # ==========================================
  # 애플리케이션 VPC의 배스천 호스트
  # BASTION HOST IN APP VPC
  # ==========================================
  BastionSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Bastion EC2 instance
      VpcId: !Ref AppVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.2.0.0/16  # Allow access from App VPC
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.1.0.0/16  # Allow access from Reporting VPC
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.1.0.0/16  # Allow ping from Reporting VPC for connectivity tests
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: sample-app-Bastion-SecurityGroup

  BastionInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/PowerUserAccess
        - arn:aws:iam::aws:policy/IAMFullAccess
      Policies:
        - PolicyName: ProjectSpecificAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                  - ssm:DeleteParameter
                  - ssm:DeleteParameters
                  - ssm:DescribeParameters
                Resource: 
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/session-tokens/*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*agentcore*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*cognito*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*troubleshooting*'
              - Effect: Allow
                Action:
                  - bedrock:CreateAgentCore
                  - bedrock:DeleteAgentCore
                  - bedrock:GetAgentCore
                  - bedrock:ListAgentCores
                  - bedrock:UpdateAgentCore
                  - bedrock:CreateAgentCoreRuntime
                  - bedrock:DeleteAgentCoreRuntime
                  - bedrock:GetAgentCoreRuntime
                  - bedrock:ListAgentCoreRuntimes
                  - bedrock:UpdateAgentCoreRuntime
                  - bedrock:InvokeAgentCore
                  - bedrock-agentcore:GetWorkloadAccessTokenForJWT
                  - bedrock-agentcore:InvokeRuntime
                  - bedrock-agentcore:GetWorkloadAccessToken
                Resource: '*'
              - Effect: Allow
                Action:
                  - rds:DescribeDBInstances
                  - rds:DescribeDBClusters
                  - rds:DescribeDBSubnetGroups
                  - rds:DescribeDBParameterGroups
                  - rds:DescribeDBClusterParameterGroups
                  - rds:ListTagsForResource
                Resource: '*'
              - Effect: Allow
                Action:
                  - cloudwatch:ListMetrics
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:GetMetricData
                  - cloudwatch:DescribeAlarms
                  - cloudwatch:PutMetricData
                Resource: '*'
              - Effect: Allow
                Action:
                  - lambda:ListFunctions
                  - lambda:GetFunction
                  - lambda:GetFunctionConfiguration
                  - lambda:InvokeFunction
                Resource: '*'
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-bastion-role'

  BastionInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref BastionInstanceRole

  BastionEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.small
      SubnetId: !Ref AppPrivateSubnet1
      SecurityGroupIds:
        - !Ref BastionSecurityGroup
      IamInstanceProfile: !Ref BastionInstanceProfile
      BlockDeviceMappings:
        - DeviceName: /dev/xvda # Or /dev/sda1 for some AMIs
          Ebs:
            VolumeSize: 50
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install -y mysql amazon-ssm-agent
          
          # Enable and start SSM agent
          systemctl enable amazon-ssm-agent
          systemctl start amazon-ssm-agent
          
          # Create the workshop directory structure on EC2
          mkdir -p "/workshop-module-1"
          mkdir -p "/workshop-module-2"
          mkdir -p "/workshop-module-3"

          # Set proper permissions
          chmod 755 "/workshop-module-1"
          chmod 755 "/workshop-module-2"
          chmod 755 "/workshop-module-3"

          echo "Bastion EC2 instance setup complete"
      Tags:
        - Key: Name
          Value: RIV-Bastion-Instance

  # ==========================================
  # 애플리케이션 VPC 인프라
  # APP VPC INFRASTRUCTURE
  # ==========================================
  AppVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.2.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: sample-app-App-VPC

  AppPublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref AppVPC
      CidrBlock: 10.2.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: sample-app-App-Public-Subnet-1

  AppPublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref AppVPC
      CidrBlock: 10.2.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: sample-app-App-Public-Subnet-2

  AppPrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref AppVPC
      CidrBlock: 10.2.3.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: sample-app-App-Private-Subnet-1

  AppPrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref AppVPC
      CidrBlock: 10.2.4.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      Tags:
        - Key: Name
          Value: sample-app-App-Private-Subnet-2

  AppInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: sample-app-App-IGW

  AppInternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref AppInternetGateway
      VpcId: !Ref AppVPC

  AppNATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt AppNATGatewayEIP.AllocationId
      SubnetId: !Ref AppPublicSubnet1
      Tags:
        - Key: Name
          Value: sample-app-App-NAT-Gateway

  AppNATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: AppInternetGatewayAttachment
    Properties:
      Domain: vpc

  AppPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref AppVPC
      Tags:
        - Key: Name
          Value: sample-app-App-Public-Routes

  AppDefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AppInternetGatewayAttachment
    Properties:
      RouteTableId: !Ref AppPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref AppInternetGateway

  AppPublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AppPublicRouteTable
      SubnetId: !Ref AppPublicSubnet1

  AppPublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AppPublicRouteTable
      SubnetId: !Ref AppPublicSubnet2

  AppPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref AppVPC
      Tags:
        - Key: Name
          Value: sample-app-App-Private-Routes

  AppDefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref AppPrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref AppNATGateway

  AppPrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AppPrivateRouteTable
      SubnetId: !Ref AppPrivateSubnet1

  AppPrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref AppPrivateRouteTable
      SubnetId: !Ref AppPrivateSubnet2

  # ==========================================
  # 리포팅 VPC 인프라
  # REPORTING VPC INFRASTRUCTURE
  # ==========================================
  ReportingVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.1.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: sample-app-Reporting-VPC

  ReportingPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ReportingVPC
      CidrBlock: 10.1.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: sample-app-Reporting-Public-Subnet

  ReportingPrivateSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref ReportingVPC
      CidrBlock: 10.1.2.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      Tags:
        - Key: Name
          Value: sample-app-Reporting-Private-Subnet

  ReportingInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: sample-app-Reporting-IGW

  ReportingInternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref ReportingInternetGateway
      VpcId: !Ref ReportingVPC

  ReportingNATGateway:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt ReportingNATGatewayEIP.AllocationId
      SubnetId: !Ref ReportingPublicSubnet
      Tags:
        - Key: Name
          Value: sample-app-Reporting-NAT-Gateway

  ReportingNATGatewayEIP:
    Type: AWS::EC2::EIP
    DependsOn: ReportingInternetGatewayAttachment
    Properties:
      Domain: vpc

  ReportingPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ReportingVPC
      Tags:
        - Key: Name
          Value: sample-app-Reporting-Public-Routes

  ReportingDefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: ReportingInternetGatewayAttachment
    Properties:
      RouteTableId: !Ref ReportingPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref ReportingInternetGateway

  ReportingPublicSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref ReportingPublicRouteTable
      SubnetId: !Ref ReportingPublicSubnet

  ReportingPrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref ReportingVPC
      Tags:
        - Key: Name
          Value: sample-app-Reporting-Private-Routes

  ReportingDefaultPrivateRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref ReportingPrivateRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref ReportingNATGateway

  ReportingPrivateSubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref ReportingPrivateRouteTable
      SubnetId: !Ref ReportingPrivateSubnet

  ReportingToAppVPCRoute:
    Type: AWS::EC2::Route
    DependsOn: ReportingVPCTransitGatewayAttachment
    Properties:
      RouteTableId: !Ref ReportingPrivateRouteTable
      DestinationCidrBlock: 10.2.0.0/16
      TransitGatewayId: !Ref TransitGateway

  # ==========================================
  # 리포팅 VPC용 VPC 엔드포인트
  # VPC ENDPOINTS FOR REPORTING VPC
  # ==========================================
  ReportingVPCEndpointSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for VPC Endpoints in Reporting VPC
      VpcId: !Ref ReportingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 10.1.0.0/16
          Description: Allow HTTPS from Reporting VPC
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ReportingServerSecurityGroup
          Description: Allow HTTPS from Reporting Server
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
          Description: Allow all outbound traffic
      Tags:
        - Key: Name
          Value: sample-app-Reporting-VPC-Endpoint-SG

  ReportingEC2VPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ReportingVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref ReportingPrivateSubnet
      SecurityGroupIds:
        - !Ref ReportingVPCEndpointSecurityGroup
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action:
              - 'ec2:*'
            Resource: '*'

  ReportingEC2MessagesVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ReportingVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ec2messages'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref ReportingPrivateSubnet
      SecurityGroupIds:
        - !Ref ReportingVPCEndpointSecurityGroup
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action:
              - 'ec2messages:*'
            Resource: '*'

  ReportingSSMVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ReportingVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssm'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref ReportingPrivateSubnet
      SecurityGroupIds:
        - !Ref ReportingVPCEndpointSecurityGroup
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action:
              - 'ssm:*'
            Resource: '*'

  ReportingSSMMessagesVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      VpcId: !Ref ReportingVPC
      ServiceName: !Sub 'com.amazonaws.${AWS::Region}.ssmmessages'
      VpcEndpointType: Interface
      SubnetIds:
        - !Ref ReportingPrivateSubnet
      SecurityGroupIds:
        - !Ref ReportingVPCEndpointSecurityGroup
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action:
              - 'ssmmessages:*'
            Resource: '*'

  # ==========================================
  # 트랜짓 게이트웨이 (VPC 간 연결)
  # TRANSIT GATEWAY
  # ==========================================
  TransitGateway:
    Type: AWS::EC2::TransitGateway
    Properties:
      AmazonSideAsn: 65000
      Description: Transit Gateway connecting App and Reporting VPCs
      Tags:
        - Key: Name
          Value: sample-app-Video-Hosting-TGW

  AppVPCTransitGatewayAttachment:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref AppVPC
      SubnetIds:
        - !Ref AppPrivateSubnet1
        - !Ref AppPrivateSubnet2
      Tags:
        - Key: Name
          Value: sample-app-App-VPC-TGW-Attachment

  ReportingVPCTransitGatewayAttachment:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGateway
      VpcId: !Ref ReportingVPC
      SubnetIds:
        - !Ref ReportingPrivateSubnet
      Tags:
        - Key: Name
          Value: sample-app-Reporting-VPC-TGW-Attachment

  TransitGatewayRouteTable:
    Type: AWS::EC2::TransitGatewayRouteTable
    Properties:
      TransitGatewayId: !Ref TransitGateway
      Tags:
        - Key: Name
          Value: sample-app-TGW-Route-Table

  AppVPCRoute:
    Type: AWS::EC2::TransitGatewayRoute
    Properties:
      DestinationCidrBlock: 10.2.0.0/16
      TransitGatewayAttachmentId: !Ref AppVPCTransitGatewayAttachment
      TransitGatewayRouteTableId: !Ref TransitGatewayRouteTable

  ReportingVPCRoute:
    Type: AWS::EC2::TransitGatewayRoute
    Properties:
      DestinationCidrBlock: 10.1.0.0/16
      TransitGatewayAttachmentId: !Ref ReportingVPCTransitGatewayAttachment
      TransitGatewayRouteTableId: !Ref TransitGatewayRouteTable

  AppToReportingRoute:
    Type: AWS::EC2::Route
    DependsOn: AppVPCTransitGatewayAttachment
    Properties:
      RouteTableId: !Ref AppPrivateRouteTable
      DestinationCidrBlock: 10.1.0.0/16
      TransitGatewayId: !Ref TransitGateway

  # ==========================================
  # 보안 그룹
  # SECURITY GROUPS
  # ==========================================
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref AppVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: sample-app-ALB-SecurityGroup

  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions
      VpcId: !Ref AppVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTP from ALB
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          SourceSecurityGroupId: !Ref ALBSecurityGroup
          Description: Allow HTTPS from ALB
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: sample-app-Lambda-SecurityGroup

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for RDS database
      VpcId: !Ref AppVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref LambdaSecurityGroup
          Description: Allow MySQL from Lambda
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          SourceSecurityGroupId: !Ref BastionSecurityGroup
          Description: Allow MySQL from Bastion
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.1.0.0/16
          Description: Allow MySQL from Reporting VPC
      Tags:
        - Key: Name
          Value: sample-app-Database-SecurityGroup

  ReportingServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Reporting EC2 instance
      VpcId: !Ref ReportingVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 10.1.0.0/16  # Allow HTTP access from Reporting VPC
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 10.2.0.0/16  # Allow HTTP access from App VPC
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.2.0.0/16  # Allow access from App VPC
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 10.1.0.0/16  # Allow access from Reporting VPC
        - IpProtocol: icmp
          FromPort: -1
          ToPort: -1
          CidrIp: 10.2.0.0/16  # Allow ping from App VPC for connectivity tests
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: sample-app-ReportingServer-SecurityGroup

  # ==========================================
  # RDS 데이터베이스 (문자셋 호환성 수정 포함)
  # RDS DATABASE WITH CHARSET COMPATIBILITY FIX
  # ==========================================
  DatabaseSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS database
      SubnetIds:
        - !Ref AppPrivateSubnet1
        - !Ref AppPrivateSubnet2
      Tags:
        - Key: Name
          Value: sample-app-Database-SubnetGroup

  # Custom DB Parameter Group for PHP 5.4 compatibility
  DatabaseParameterGroup:
    Type: AWS::RDS::DBParameterGroup
    Properties:
      Family: mysql8.0
      Description: MySQL 8.0 parameter group with PHP 5.4 charset compatibility
      Parameters:
        character_set_server: utf8
        collation_server: utf8_general_ci
        character_set_client: utf8
        character_set_connection: utf8
        character_set_results: utf8
        character_set_database: utf8
        default_authentication_plugin: mysql_native_password
        innodb_default_row_format: dynamic
        sql_mode: TRADITIONAL
        skip_name_resolve: 1
        max_connections: 100
      Tags:
        - Key: Name
          Value: sample-app-Database-ParameterGroup

  ImageMetadataDatabase:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: sample-app-image-metadata-db
      DBInstanceClass: db.t3.micro
      Engine: mysql
      EngineVersion: '8.0'
      MasterUsername: !Ref DBUsername
      MasterUserPassword: !Ref DBPassword
      AllocatedStorage: 20
      StorageType: gp2
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DatabaseSubnetGroup
      DBParameterGroupName: !Ref DatabaseParameterGroup
      BackupRetentionPeriod: 7
      MultiAZ: false
      PubliclyAccessible: false
      StorageEncrypted: true
      Tags:
        - Key: Name
          Value: sample-app-ImageMetadataDatabase

  # ==========================================
  # IAM 역할 및 정책
  # IAM ROLES AND POLICIES
  # ==========================================
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole
      Policies:
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                Resource: !Sub "arn:aws:s3:::${ImageBucket}/*"
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudwatch:PutMetricData
                Resource: "*"
        - PolicyName: SSMParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                  - ssm:PutParameter
                  - ssm:DeleteParameter
                Resource: 
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*examplecorp*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*analytics*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*support*'

  # ==========================================
  # PyMySQL용 Lambda 레이어
  # LAMBDA LAYER FOR PYMYSQL
  # ==========================================
  PyMySQLLayer:
    Type: AWS::Lambda::LayerVersion
    DependsOn: CreatePyMySQLLayerResource
    Properties:
      LayerName: pymysql-layer
      Description: PyMySQL library for Lambda functions
      Content:
        S3Bucket: !Ref ImageBucket
        S3Key: layers/pymysql-layer.zip
      CompatibleRuntimes:
        - python3.9
      LicenseInfo: MIT

  CreatePyMySQLLayerFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: sample-app-create-pymysql-layer
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      Code:
        ZipFile: |
          import boto3
          import json
          import cfnresponse
          import zipfile
          import io
          import subprocess
          import os
          import tempfile
          
          def lambda_handler(event, context):
              print(f"Lambda invoked with event: {json.dumps(event)}")
              
              try:
                  s3_client = boto3.client('s3')
                  bucket_name = event['ResourceProperties']['BucketName']
                  
                  if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':
                      print("Creating PyMySQL layer...")
                      
                      with tempfile.TemporaryDirectory() as temp_dir:
                          python_dir = os.path.join(temp_dir, 'python')
                          os.makedirs(python_dir)
                          
                          subprocess.check_call([
                              'pip', 'install', 'PyMySQL==1.0.2', 
                              '--target', python_dir,
                              '--no-deps'
                          ])
                          
                          zip_buffer = io.BytesIO()
                          with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
                              for root, dirs, files in os.walk(temp_dir):
                                  for file in files:
                                      file_path = os.path.join(root, file)
                                      arc_name = os.path.relpath(file_path, temp_dir)
                                      zip_file.write(file_path, arc_name)
                          
                          zip_buffer.seek(0)
                          s3_client.put_object(
                              Bucket=bucket_name,
                              Key='layers/pymysql-layer.zip',
                              Body=zip_buffer.getvalue(),
                              ContentType='application/zip'
                          )
                          
                          print("PyMySQL layer created and uploaded successfully")
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
                  elif event['RequestType'] == 'Delete':
                      try:
                          s3_client.delete_object(Bucket=bucket_name, Key='layers/pymysql-layer.zip')
                      except:
                          pass
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  CreatePyMySQLLayerResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt CreatePyMySQLLayerFunction.Arn
      BucketName: !Ref ImageBucket
    DependsOn: ImageBucket

  ReportingServerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/PowerUserAccess
        - arn:aws:iam::aws:policy/IAMFullAccess
      Policies:
        - PolicyName: ProjectSpecificAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:PutParameter
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                  - ssm:DeleteParameter
                  - ssm:DeleteParameters
                  - ssm:DescribeParameters
                Resource: 
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/session-tokens/*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*agentcore*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*cognito*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*troubleshooting*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*examplecorp*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*analytics*'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/*reporting*'
              - Effect: Allow
                Action:
                  - bedrock:CreateAgentCore
                  - bedrock:DeleteAgentCore
                  - bedrock:GetAgentCore
                  - bedrock:ListAgentCores
                  - bedrock:UpdateAgentCore
                  - bedrock:CreateAgentCoreRuntime
                  - bedrock:DeleteAgentCoreRuntime
                  - bedrock:GetAgentCoreRuntime
                  - bedrock:ListAgentCoreRuntimes
                  - bedrock:UpdateAgentCoreRuntime
                  - bedrock:InvokeAgentCore
                  - bedrock-agentcore:GetWorkloadAccessTokenForJWT
                  - bedrock-agentcore:InvokeRuntime
                  - bedrock-agentcore:GetWorkloadAccessToken
                Resource: '*'
              - Effect: Allow
                Action:
                  - rds:DescribeDBInstances
                  - rds:DescribeDBClusters
                  - rds:DescribeDBSubnetGroups
                  - rds:DescribeDBParameterGroups
                  - rds:DescribeDBClusterParameterGroups
                  - rds:ListTagsForResource
                Resource: '*'
              - Effect: Allow
                Action:
                  - cloudwatch:ListMetrics
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:GetMetricData
                  - cloudwatch:DescribeAlarms
                  - cloudwatch:PutMetricData
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Effect: Allow
                Action:
                  - lambda:ListFunctions
                  - lambda:GetFunction
                  - lambda:GetFunctionConfiguration
                  - lambda:InvokeFunction
                Resource: '*'
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                Resource: 
                  - !Sub "arn:aws:s3:::${ImageBucket}"
                  - !Sub "arn:aws:s3:::${ImageBucket}/*"
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-reporting-server-role'

  ReportingServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref ReportingServerRole

  # ==========================================
  # 데이터베이스 연결용 SSM 파라미터
  # SSM PARAMETERS FOR DATABASE CONNECTION
  # ==========================================
  DatabaseHostParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /examplecorp/database/host
      Type: String
      Value: !GetAtt ImageMetadataDatabase.Endpoint.Address
      Description: Database host endpoint for ExampleCorp application

  DatabaseUsernameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /examplecorp/database/username
      Type: String
      Value: !Ref DBUsername
      Description: Database username for ExampleCorp application

  DatabasePasswordParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /examplecorp/database/password
      Type: String
      Value: !Ref DBPassword
      Description: Database password for ExampleCorp application

  DatabaseNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /examplecorp/database/name
      Type: String
      Value: image_metadata
      Description: Database name for ExampleCorp application

  ALBURLParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Name: /examplecorp/alb/url
      Type: String
      Value: !Sub "http://${ApplicationLoadBalancer.DNSName}"
      Description: Application Load Balancer URL for ExampleCorp application

  # ==========================================
  # 지원 티켓 API Gateway 및 Lambda
  # SUPPORT TICKET API GATEWAY AND LAMBDA
  # ==========================================
  SupportTicketApiGateway:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: !Sub "${AWS::StackName}-support-ticket-api"
      Description: API Gateway for Support Ticket functionality
      EndpointConfiguration:
        Types:
          - REGIONAL
      Policy:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: '*'
            Action: 'execute-api:Invoke'
            Resource: '*'

  SupportTicketApiResource:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SupportTicketApiGateway
      ParentId: !GetAtt SupportTicketApiGateway.RootResourceId
      PathPart: tickets

  SupportTicketApiResourceProxy:
    Type: AWS::ApiGateway::Resource
    Properties:
      RestApiId: !Ref SupportTicketApiGateway
      ParentId: !Ref SupportTicketApiResource
      PathPart: '{proxy+}'

  SupportTicketApiMethod:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SupportTicketApiGateway
      ResourceId: !Ref SupportTicketApiResource
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SupportTicketFunction.Arn}/invocations"

  SupportTicketApiMethodProxy:
    Type: AWS::ApiGateway::Method
    Properties:
      RestApiId: !Ref SupportTicketApiGateway
      ResourceId: !Ref SupportTicketApiResourceProxy
      HttpMethod: ANY
      AuthorizationType: NONE
      Integration:
        Type: AWS_PROXY
        IntegrationHttpMethod: POST
        Uri: !Sub "arn:aws:apigateway:${AWS::Region}:lambda:path/2015-03-31/functions/${SupportTicketFunction.Arn}/invocations"

  SupportTicketApiDeployment:
    Type: AWS::ApiGateway::Deployment
    DependsOn:
      - SupportTicketApiMethod
      - SupportTicketApiMethodProxy
    Properties:
      RestApiId: !Ref SupportTicketApiGateway
      StageName: prod

  SupportTicketLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref SupportTicketFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${SupportTicketApiGateway}/*/*"

  SupportTicketFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-support-ticket-handler"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      Layers:
        - !Ref PyMySQLLayer
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref AppPrivateSubnet1
          - !Ref AppPrivateSubnet2
      Environment:
        Variables:
          DB_HOST: !GetAtt ImageMetadataDatabase.Endpoint.Address
          DB_USER: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_NAME: image_metadata
      Code:
        ZipFile: |
          import json
          import os
          import uuid
          from datetime import datetime
          import pymysql

          db_connection = None

          def get_db_connection():
              global db_connection
              
              if db_connection is None or not db_connection.open:
                  try:
                      db_connection = pymysql.connect(
                          host=os.environ['DB_HOST'],
                          user=os.environ['DB_USER'],
                          password=os.environ['DB_PASSWORD'],
                          database=os.environ['DB_NAME'],
                          charset='utf8mb4',
                          cursorclass=pymysql.cursors.DictCursor,
                          autocommit=True
                      )
                      print("Database connection established")
                  except Exception as e:
                      print(f"Database connection error: {e}")
                      raise Exception("Failed to establish database connection")
              
              return db_connection

          def create_support_ticket(data):
              try:
                  conn = get_db_connection()
                  ticket_id = str(uuid.uuid4())
                  
                  with conn.cursor() as cursor:
                      cursor.execute("""
                          INSERT INTO support_tickets (id, subject, description, priority, status, created_at, updated_at)
                          VALUES (%s, %s, %s, %s, 'open', NOW(), NOW())
                      """, (
                          ticket_id,
                          data.get('subject', 'No Subject'),
                          data.get('description', ''),
                          data.get('priority', 'medium')
                      ))
                      
                      # Get the created ticket
                      cursor.execute("""
                          SELECT * FROM support_tickets WHERE id = %s
                      """, (ticket_id,))
                      
                      ticket = cursor.fetchone()
                      if ticket:
                          # Convert datetime objects to strings
                          ticket['created_at'] = ticket['created_at'].isoformat() if ticket['created_at'] else None
                          ticket['updated_at'] = ticket['updated_at'].isoformat() if ticket['updated_at'] else None
                      
                      return ticket
                      
              except Exception as e:
                  print(f"Error creating support ticket: {e}")
                  raise

          def get_support_tickets():
              try:
                  conn = get_db_connection()
                  
                  with conn.cursor() as cursor:
                      cursor.execute("""
                          SELECT * FROM support_tickets 
                          ORDER BY created_at DESC
                      """)
                      
                      tickets = cursor.fetchall()
                      
                      # Convert datetime objects to strings
                      for ticket in tickets:
                          ticket['created_at'] = ticket['created_at'].isoformat() if ticket['created_at'] else None
                          ticket['updated_at'] = ticket['updated_at'].isoformat() if ticket['updated_at'] else None
                      
                      return tickets
                      
              except Exception as e:
                  print(f"Error getting support tickets: {e}")
                  raise

          def get_support_ticket(ticket_id):
              try:
                  conn = get_db_connection()
                  
                  with conn.cursor() as cursor:
                      cursor.execute("""
                          SELECT * FROM support_tickets WHERE id = %s
                      """, (ticket_id,))
                      
                      ticket = cursor.fetchone()
                      if ticket:
                          ticket['created_at'] = ticket['created_at'].isoformat() if ticket['created_at'] else None
                          ticket['updated_at'] = ticket['updated_at'].isoformat() if ticket['updated_at'] else None
                          
                          # Get correspondence messages
                          cursor.execute("""
                              SELECT * FROM correspondence_messages 
                              WHERE ticket_id = %s 
                              ORDER BY created_at ASC
                          """, (ticket_id,))
                          
                          messages = cursor.fetchall()
                          for message in messages:
                              message['created_at'] = message['created_at'].isoformat() if message['created_at'] else None
                          
                          ticket['correspondence'] = messages
                      
                      return ticket
                      
              except Exception as e:
                  print(f"Error getting support ticket: {e}")
                  raise

          def update_support_ticket(ticket_id, data):
              try:
                  conn = get_db_connection()
                  
                  with conn.cursor() as cursor:
                      # Update ticket
                      update_fields = []
                      update_values = []
                      
                      if 'subject' in data:
                          update_fields.append('subject = %s')
                          update_values.append(data['subject'])
                      
                      if 'description' in data:
                          update_fields.append('description = %s')
                          update_values.append(data['description'])
                      
                      if 'priority' in data:
                          update_fields.append('priority = %s')
                          update_values.append(data['priority'])
                      
                      if 'status' in data:
                          update_fields.append('status = %s')
                          update_values.append(data['status'])
                      
                      if update_fields:
                          update_fields.append('updated_at = NOW()')
                          update_values.append(ticket_id)
                          
                          cursor.execute(f"""
                              UPDATE support_tickets 
                              SET {', '.join(update_fields)}
                              WHERE id = %s
                          """, update_values)
                      
                      return get_support_ticket(ticket_id)
                      
              except Exception as e:
                  print(f"Error updating support ticket: {e}")
                  raise

          def add_correspondence(ticket_id, data):
              try:
                  conn = get_db_connection()
                  
                  with conn.cursor() as cursor:
                      # Get next correspondence ID for this ticket
                      cursor.execute("""
                          SELECT COALESCE(MAX(correspondence_id), 0) + 1 as next_id
                          FROM correspondence_messages 
                          WHERE ticket_id = %s
                      """, (ticket_id,))
                      
                      result = cursor.fetchone()
                      correspondence_id = result['next_id'] if result else 1
                      
                      cursor.execute("""
                          INSERT INTO correspondence_messages 
                          (ticket_id, correspondence_id, author, message, message_type, session_id, created_at)
                          VALUES (%s, %s, %s, %s, %s, %s, NOW())
                      """, (
                          ticket_id,
                          correspondence_id,
                          data.get('author', 'Anonymous'),
                          data.get('message', ''),
                          data.get('message_type', 'user'),
                          data.get('session_id', '')
                      ))
                      
                      # Update ticket's updated_at timestamp
                      cursor.execute("""
                          UPDATE support_tickets 
                          SET updated_at = NOW()
                          WHERE id = %s
                      """, (ticket_id,))
                      
                      return get_support_ticket(ticket_id)
                      
              except Exception as e:
                  print(f"Error adding correspondence: {e}")
                  raise

          def delete_support_ticket(ticket_id):
              try:
                  conn = get_db_connection()
                  
                  with conn.cursor() as cursor:
                      # Delete correspondence messages first
                      cursor.execute("""
                          DELETE FROM correspondence_messages WHERE ticket_id = %s
                      """, (ticket_id,))
                      
                      # Delete ticket
                      cursor.execute("""
                          DELETE FROM support_tickets WHERE id = %s
                      """, (ticket_id,))
                      
                      return cursor.rowcount > 0
                      
              except Exception as e:
                  print(f"Error deleting support ticket: {e}")
                  raise

          def lambda_handler(event, context):
              try:
                  print(f"Support Ticket API Request: {json.dumps(event)}")
                  
                  path = event.get('path', '/')
                  method = event.get('httpMethod', 'GET')
                  path_parameters = event.get('pathParameters') or {}
                  
                  # CORS headers
                  cors_headers = {
                      'Access-Control-Allow-Origin': '*',
                      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
                      'Access-Control-Allow-Headers': 'Content-Type, Authorization'
                  }
                  
                  # Handle OPTIONS requests
                  if method == 'OPTIONS':
                      return {
                          'statusCode': 200,
                          'headers': cors_headers,
                          'body': ''
                      }
                  
                  # Parse request body
                  body_data = {}
                  if event.get('body'):
                      try:
                          body_data = json.loads(event['body'])
                      except json.JSONDecodeError:
                          return {
                              'statusCode': 400,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'error': 'Invalid JSON in request body'})
                          }
                  
                  # Debug logging to help troubleshoot path issues
                  print(f"Support Ticket API - Path: '{path}', Method: '{method}'")
                  print(f"Path parameters: {path_parameters}")
                  
                  # Normalize path - API Gateway might send different path formats
                  normalized_path = path
                  if normalized_path.startswith('/prod/'):
                      normalized_path = normalized_path[5:]  # Remove /prod/ prefix
                  if not normalized_path.startswith('/'):
                      normalized_path = '/' + normalized_path
                  
                  print(f"Normalized path: '{normalized_path}'")
                  
                  # Route requests
                  if (normalized_path == '/tickets' or normalized_path == '/') and method == 'GET':
                      # List all tickets
                      tickets = get_support_tickets()
                      return {
                          'statusCode': 200,
                          'headers': {**cors_headers, 'Content-Type': 'application/json'},
                          'body': json.dumps({'tickets': tickets})
                      }
                  
                  elif (normalized_path == '/tickets' or normalized_path == '/') and method == 'POST':
                      # Create new ticket
                      ticket = create_support_ticket(body_data)
                      return {
                          'statusCode': 201,
                          'headers': {**cors_headers, 'Content-Type': 'application/json'},
                          'body': json.dumps({'ticket': ticket})
                      }
                  
                  elif normalized_path.startswith('/tickets/') and method == 'GET':
                      # Get specific ticket
                      ticket_id = normalized_path.split('/')[-1]
                      ticket = get_support_ticket(ticket_id)
                      
                      if ticket:
                          return {
                              'statusCode': 200,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'ticket': ticket})
                          }
                      else:
                          return {
                              'statusCode': 404,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'error': 'Ticket not found'})
                          }
                  
                  elif normalized_path.startswith('/tickets/') and method == 'PUT':
                      # Update ticket
                      ticket_id = normalized_path.split('/')[-1]
                      ticket = update_support_ticket(ticket_id, body_data)
                      
                      if ticket:
                          return {
                              'statusCode': 200,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'ticket': ticket})
                          }
                      else:
                          return {
                              'statusCode': 404,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'error': 'Ticket not found'})
                          }
                  
                  elif normalized_path.startswith('/tickets/') and normalized_path.endswith('/correspondence') and method == 'POST':
                      # Add correspondence to ticket
                      ticket_id = normalized_path.split('/')[-2]
                      ticket = add_correspondence(ticket_id, body_data)
                      
                      if ticket:
                          return {
                              'statusCode': 201,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'ticket': ticket})
                          }
                      else:
                          return {
                              'statusCode': 404,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'error': 'Ticket not found'})
                          }
                  
                  elif normalized_path.startswith('/tickets/') and method == 'DELETE':
                      # Delete ticket
                      ticket_id = normalized_path.split('/')[-1]
                      success = delete_support_ticket(ticket_id)
                      
                      if success:
                          return {
                              'statusCode': 200,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'message': 'Ticket deleted successfully'})
                          }
                      else:
                          return {
                              'statusCode': 404,
                              'headers': {**cors_headers, 'Content-Type': 'application/json'},
                              'body': json.dumps({'error': 'Ticket not found'})
                          }
                  
                  else:
                      return {
                          'statusCode': 404,
                          'headers': {**cors_headers, 'Content-Type': 'application/json'},
                          'body': json.dumps({'error': f'Not found: {method} {normalized_path} (original: {path})'})
                      }
                  
              except Exception as e:
                  print(f"Support Ticket Lambda error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({'error': f'Internal server error: {str(e)}'})
                  }

  # ==========================================
  # SUPPORT TICKET URL REPLACEMENT FUNCTION
  # ==========================================
  UpdateSupportURLFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: sample-app-update-support-url
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3
          import json
          import cfnresponse
          
          def lambda_handler(event, context):
              try:
                  if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':
                      # Get the API Gateway URL from the resource properties
                      api_gateway_url = event['ResourceProperties']['ApiGatewayUrl']
                      
                      print(f"Support Ticket API Gateway URL: {api_gateway_url}")
                      
                      # Store the URL in SSM Parameter for the HTML rendering function to use
                      ssm = boto3.client('ssm')
                      ssm.put_parameter(
                          Name='/examplecorp/support/api-gateway-url',
                          Value=api_gateway_url,
                          Type='String',
                          Overwrite=True,
                          Description='API Gateway URL for Support Ticket system'
                      )
                      
                      print("Support API Gateway URL stored in SSM Parameter Store")
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
                  elif event['RequestType'] == 'Delete':
                      # Clean up SSM parameter
                      try:
                          ssm = boto3.client('ssm')
                          ssm.delete_parameter(Name='/examplecorp/support/api-gateway-url')
                      except:
                          pass
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  UpdateSupportURLResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt UpdateSupportURLFunction.Arn
      ApiGatewayUrl: !Sub "https://${SupportTicketApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod"
    DependsOn: 
      - SupportTicketApiGateway
      - SupportTicketApiDeployment

  # ==========================================
  # Lambda 함수
  # LAMBDA FUNCTIONS - IMPLEMENTING REQUIRED FLOW
  # ==========================================
  
  UploadContentFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: sample-app-upload-content
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 300
      Environment:
        Variables:
          FORCE_UPDATE: !Sub "${AWS::StackName}-${AWS::Region}-v17"
      Code:
        ZipFile: |
          import boto3
          import json
          import cfnresponse
          import urllib.request
          import urllib.error
          import base64
          
          def lambda_handler(event, context):
              print(f"Lambda invoked with event: {json.dumps(event)}")
              
              try:
                  s3_client = boto3.client('s3')
                  bucket_name = event['ResourceProperties']['BucketName']
                  print(f"Working with S3 bucket: {bucket_name}")
                  
                  if event['RequestType'] == 'Create' or event['RequestType'] == 'Update':
                      print("=== STARTING IMAGE DOWNLOAD AND UPLOAD PROCESS ===")
                      
                      fallback_image = base64.b64decode('/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/2wBDAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQH/wAARCAEsAZADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD9/KKKKAP/2Q==')
                      
                      images_to_process = [
                          {'url': 'https://ws-assets-prod-iad-r-iad-ed304a55c2ca1aee.s3.us-east-1.amazonaws.com/25286efc-5ab4-45b2-a654-bc31f00e0426/acme-image-gallery/riv20.jpg', 'key': 'images/riv-20.jpeg', 'title': 're:Invent 2020'},
                          {'url': 'https://ws-assets-prod-iad-r-iad-ed304a55c2ca1aee.s3.us-east-1.amazonaws.com/25286efc-5ab4-45b2-a654-bc31f00e0426/acme-image-gallery/riv-21.jpg', 'key': 'images/riv-21.jpeg', 'title': 're:Invent 2021'},
                          {'url': 'https://ws-assets-prod-iad-r-iad-ed304a55c2ca1aee.s3.us-east-1.amazonaws.com/25286efc-5ab4-45b2-a654-bc31f00e0426/acme-image-gallery/riv-22.jpg', 'key': 'images/riv-22.jpeg', 'title': 're:Invent 2022'},
                          {'url': 'https://ws-assets-prod-iad-r-icn-ced060f0d38bc0b0.s3.ap-northeast-2.amazonaws.com/25286efc-5ab4-45b2-a654-bc31f00e0426/acme-image-gallery/riv-23.jpeg', 'key': 'images/riv-23.jpeg', 'title': 're:Invent 2023'},
                          {'url': 'https://ws-assets-prod-iad-r-iad-ed304a55c2ca1aee.s3.us-east-1.amazonaws.com/25286efc-5ab4-45b2-a654-bc31f00e0426/acme-image-gallery/riv-24.png', 'key': 'images/riv-24.jpeg', 'title': 're:Invent 2024'},
                          {'url': 'https://ws-assets-prod-iad-r-icn-ced060f0d38bc0b0.s3.ap-northeast-2.amazonaws.com/25286efc-5ab4-45b2-a654-bc31f00e0426/acme-image-gallery/riv-25.jpeg', 'key': 'images/riv-25.jpeg', 'title': 're:Invent 2025'}
                      ]
                      
                      successful_uploads = 0
                      
                      for img_info in images_to_process:
                          try:
                              print(f"\n--- Processing {img_info['title']} ---")
                              
                              image_data = None
                              try:
                                  print("Attempting to download from URL...")
                                  request = urllib.request.Request(img_info['url'])
                                  request.add_header('User-Agent', 'Mozilla/5.0 (compatible; AWS Lambda)')
                                  
                                  with urllib.request.urlopen(request, timeout=30) as response:
                                      if response.status == 200:
                                          image_data = response.read()
                                          print(f"Downloaded {len(image_data)} bytes")
                                      else:
                                          print(f"HTTP {response.status}")
                              except Exception as download_error:
                                  print(f"Download failed: {str(download_error)}")
                              
                              if image_data is None:
                                  print("Using fallback image...")
                                  image_data = fallback_image
                              
                              content_type = 'image/jpeg'
                              if img_info['key'].lower().endswith('.png'):
                                  content_type = 'image/png'
                              
                              s3_client.put_object(
                                  Bucket=bucket_name,
                                  Key=img_info['key'],
                                  Body=image_data,
                                  ContentType=content_type,
                                  Metadata={
                                      'title': img_info['title'],
                                      'source': 'lambda-upload'
                                  }
                              )
                              print(f"Successfully uploaded {img_info['key']}")
                              
                              successful_uploads += 1
                              
                          except Exception as process_error:
                              print(f"Error processing {img_info['title']}: {str(process_error)}")
                              continue
                      
                      print(f"Successfully uploaded {successful_uploads} out of {len(images_to_process)} images")
                      
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
                  elif event['RequestType'] == 'Delete':
                      cfnresponse.send(event, context, cfnresponse.SUCCESS, {})
                      
              except Exception as e:
                  print(f"Error: {str(e)}")
                  cfnresponse.send(event, context, cfnresponse.FAILED, {})

  UploadContentResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt UploadContentFunction.Arn
      BucketName: !Ref ImageBucket
    DependsOn: ImageBucket

  # ==========================================
  # LAMBDA 1: HTML RENDERING AND DATABASE QUERY
  # Flow: User refreshes ? HTML Rendering Lambda ? Database query ? Updated counts displayed
  # Flow: User clicks Reports tab ? HTML Rendering Lambda ? Reporting server ? Database ? Analytics displayed
  # ==========================================
  HTMLRenderingFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "sample-app-html-renderer-${AWS::StackName}"
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      Layers:
        - !Ref PyMySQLLayer
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref AppPrivateSubnet1
          - !Ref AppPrivateSubnet2
      Environment:
        Variables:
          DB_HOST: !GetAtt ImageMetadataDatabase.Endpoint.Address
          DB_USER: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_NAME: image_metadata
          LAYOUT_VERSION: "v6-flow-implementation"
          FORCE_UPDATE: !Sub "${AWS::StackName}-${AWS::Region}-v21-${AWS::AccountId}"
          DEPLOYMENT_TIME: "2025-10-04-15-46"
          REPORTING_SERVER_IP: !GetAtt ReportingEC2Instance.PrivateIp
      Code:
        ZipFile: |
          import json
          import os
          from datetime import datetime
          
          import pymysql
          
          db_connection = None
          db_initialized = False
          
          def get_db_connection():
              global db_connection
              
              if db_connection is None or not db_connection.open:
                  try:
                      db_connection = pymysql.connect(
                          host=os.environ['DB_HOST'],
                          user=os.environ['DB_USER'],
                          password=os.environ['DB_PASSWORD'],
                          database=os.environ['DB_NAME'],
                          charset='utf8mb4',
                          cursorclass=pymysql.cursors.DictCursor,
                          autocommit=True
                      )
                      print("Database connection established")
                  except Exception as e:
                      print(f"Database connection error: {e}")
                      try:
                          db_connection = pymysql.connect(
                              host=os.environ['DB_HOST'],
                              user=os.environ['DB_USER'],
                              password=os.environ['DB_PASSWORD'],
                              charset='utf8mb4',
                              cursorclass=pymysql.cursors.DictCursor,
                              autocommit=True
                          )
                          print("Database connection established without database name")
                      except Exception as e2:
                          print(f"Fallback database connection error: {e2}")
                          raise Exception("Failed to establish database connection")
              
              return db_connection
          
          def init_database():
              global db_initialized
              
              if db_initialized:
                  return True
              
              try:
                  conn = get_db_connection()
                  if conn is None:
                      return False
                  
                  with conn.cursor() as cursor:
                      cursor.execute(f"CREATE DATABASE IF NOT EXISTS {os.environ['DB_NAME']}")
                      cursor.execute(f"USE {os.environ['DB_NAME']}")
                      
                      cursor.execute("""
                          CREATE TABLE IF NOT EXISTS images (
                              id INT PRIMARY KEY,
                              title VARCHAR(255) NOT NULL,
                              description TEXT,
                              image_url VARCHAR(500) NOT NULL,
                              width INT,
                              height INT,
                              likes_count INT DEFAULT 0,
                              shares_count INT DEFAULT 0,
                              views_count INT DEFAULT 0,
                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
                          )
                      """)
                      
                      cursor.execute("""
                          CREATE TABLE IF NOT EXISTS image_interactions (
                              id INT AUTO_INCREMENT PRIMARY KEY,
                              image_id INT NOT NULL,
                              action ENUM('like', 'share', 'view') NOT NULL,
                              session_id VARCHAR(255),
                              ip_address VARCHAR(45),
                              user_agent TEXT,
                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                              FOREIGN KEY (image_id) REFERENCES images(id)
                          )
                      """)
                      
                      # CLEAN VERSION: Empty support ticket tables (no pre-populated tickets)
                      cursor.execute("""
                          CREATE TABLE IF NOT EXISTS support_tickets (
                              id VARCHAR(50) PRIMARY KEY,
                              subject VARCHAR(255) NOT NULL,
                              description TEXT,
                              priority ENUM('low', 'medium', 'high', 'sev1') DEFAULT 'medium',
                              status ENUM('open', 'in_progress', 'closed') DEFAULT 'open',
                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                              INDEX idx_status (status),
                              INDEX idx_priority (priority),
                              INDEX idx_created_at (created_at)
                          )
                      """)
                      
                      cursor.execute("""
                          CREATE TABLE IF NOT EXISTS correspondence_messages (
                              id INT AUTO_INCREMENT PRIMARY KEY,
                              ticket_id VARCHAR(50) NOT NULL,
                              correspondence_id INT NOT NULL,
                              author VARCHAR(100) NOT NULL,
                              message TEXT NOT NULL,
                              message_type ENUM('system', 'user', 'agent') DEFAULT 'user',
                              session_id VARCHAR(255),
                              ip_address VARCHAR(45),
                              user_agent TEXT,
                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                              FOREIGN KEY (ticket_id) REFERENCES support_tickets(id),
                              INDEX idx_ticket_id (ticket_id),
                              INDEX idx_correspondence_id (correspondence_id),
                              INDEX idx_created_at (created_at)
                          )
                      """)
                      
                      cursor.execute("""
                          CREATE TABLE IF NOT EXISTS workshop_modules (
                              id INT AUTO_INCREMENT PRIMARY KEY,
                              module_name VARCHAR(100) NOT NULL UNIQUE,
                              display_name VARCHAR(150) NOT NULL,
                              current_progress INT DEFAULT 0,
                              max_progress INT DEFAULT 100,
                              is_completed BOOLEAN DEFAULT FALSE,
                              completion_date TIMESTAMP NULL,
                              created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                              updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
                              INDEX idx_module_name (module_name),
                              INDEX idx_is_completed (is_completed)
                          )
                      """)
                      
                      workshop_modules = [
                          ('agentcore_runtime', 'AgentCore Runtime', 0, 100),
                          ('agentcore_memory', 'AgentCore Memory', 0, 100),
                          ('a2a', 'A2A', 0, 100),
                          ('cloudwatch_investigations', 'CloudWatch Investigations', 0, 100)
                      ]
                      
                      for module_name, display_name, progress, max_progress in workshop_modules:
                          cursor.execute("""
                              INSERT INTO workshop_modules 
                              (module_name, display_name, current_progress, max_progress, is_completed) 
                              VALUES (%s, %s, %s, %s, %s)
                              ON DUPLICATE KEY UPDATE
                              display_name = VALUES(display_name),
                              updated_at = CURRENT_TIMESTAMP
                          """, (module_name, display_name, progress, max_progress, False))
                      
                      initial_images = [
                          (1, 're:Invent 2020', 're:Invent 2020', '/images/riv-20.jpeg', 1200, 800, 0, 0, 0),
                          (2, 're:Invent 2021', 're:Invent 2021', '/images/riv-21.jpeg', 1400, 900, 0, 0, 0),
                          (3, 're:Invent 2022', 're:Invent 2022', '/images/riv-22.jpeg', 1100, 700, 0, 0, 0),
                          (4, 're:Invent 2023', 're:Invent 2023', '/images/riv-23.jpeg', 1300, 850, 0, 0, 0),
                          (5, 're:Invent 2024', 're:Invent 2024', '/images/riv-24.jpeg', 1250, 750, 0, 0, 0),
                          (6, 're:Invent 2025', 're:Invent 2025', '/images/riv-25.jpeg', 1150, 800, 0, 0, 0)
                      ]
                      
                      for image_data in initial_images:
                          cursor.execute("""
                              INSERT INTO images 
                              (id, title, description, image_url, width, height, likes_count, shares_count, views_count) 
                              VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)
                              ON DUPLICATE KEY UPDATE
                              title = VALUES(title),
                              description = VALUES(description),
                              image_url = VALUES(image_url),
                              width = VALUES(width),
                              height = VALUES(height),
                              updated_at = CURRENT_TIMESTAMP
                          """, image_data)
                      
                      cursor.execute("DELETE FROM image_interactions")
                      
                      print("Database tables created and initialized successfully (clean version)")
                      db_initialized = True
                      return True
                      
              except Exception as e:
                  print(f"Database initialization error: {e}")
                  return False
          
          def lambda_handler(event, context):
              try:
                  init_database()
                  
                  path = event.get('path', '/')
                  method = event.get('httpMethod', 'GET')
                  
                  print(f"HTML Renderer Request: {method} {path}")
                  
                  if path == '/' or path == '/index.html':
                      html_content = '''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ExampleCorp.com - Image Gallery</title>
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #ffffff; color: #333; line-height: 1.6; }
                  .header { background: #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: fixed; top: 0; left: 0; right: 0; z-index: 1000; padding: 12px 20px; }
                  .header-content { max-width: 1200px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
                  .logo { font-size: 24px; font-weight: bold; color: #e60023; text-decoration: none; }
                  .nav-links { display: flex; gap: 20px; margin: 0 20px; }
                  .nav-link { padding: 8px 16px; text-decoration: none; color: #666; border-radius: 20px; transition: all 0.3s ease; font-weight: 500; cursor: pointer; }
                  .nav-link:hover, .nav-link.active { background-color: #e60023; color: white; }
                  .search-bar { flex: 1; max-width: 400px; position: relative; }
                  .search-input { width: 100%; padding: 12px 20px; border: none; border-radius: 24px; background-color: #f1f1f1; font-size: 16px; outline: none; transition: all 0.3s ease; }
                  .search-input:focus { background-color: #ffffff; box-shadow: 0 0 0 3px rgba(230, 0, 35, 0.1); }
                  .main-container { margin-top: 80px; max-width: 1400px; margin-left: auto; margin-right: auto; padding: 20px; }
                  .page-title { font-size: 28px; font-weight: 600; margin-bottom: 20px; color: #333; text-align: center; }
                  .horizontal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; padding: 0 10px; justify-items: center; }
                  .image-card { background: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; cursor: pointer; position: relative; width: 100%; max-width: 400px; }
                  .image-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
                  .image-thumbnail { position: relative; overflow: hidden; }
                  .image-card img { width: 100%; height: 240px; object-fit: cover; display: block; transition: transform 0.3s ease; background-color: #f8f9fa; }
                  .image-card:hover img { transform: scale(1.02); }
                  .image-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, transparent 0%, rgba(0,0,0,0.7) 100%); opacity: 0; transition: opacity 0.3s ease; display: flex; align-items: flex-end; padding: 16px; }
                  .image-card:hover .image-overlay { opacity: 1; }
                  .image-actions { display: flex; gap: 8px; }
                  .action-btn { background: rgba(255,255,255,0.9); border: none; border-radius: 20px; padding: 8px 12px; font-size: 12px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 4px; }
                  .action-btn:hover { background: white; transform: scale(1.05); }
                  .image-info { padding: 16px; }
                  .image-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #333; line-height: 1.3; }
                  .image-description { font-size: 14px; color: #666; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
                  .image-stats { display: flex; align-items: center; gap: 12px; margin-top: 12px; font-size: 12px; color: #999; }
                  .stat-item { display: flex; align-items: center; gap: 4px; }
                  .loading { text-align: center; padding: 40px; font-size: 18px; color: #666; }
                  .error { text-align: center; padding: 40px; color: #e60023; font-size: 18px; }
                  
                  /* Support Tickets Styles - Clean Empty State */
                  .support-container { max-width: 1200px; margin: 0 auto; }
                  .support-layout { display: grid; grid-template-columns: 1fr 300px; gap: 24px; }
                  @media (max-width: 768px) { .support-layout { grid-template-columns: 1fr; } }
                  .support-main { display: flex; flex-direction: column; gap: 24px; }
                  .support-sidebar { display: flex; flex-direction: column; gap: 24px; }
                  
                  .tickets-list { display: grid; gap: 16px; min-height: 200px; }
                  .empty-state { text-align: center; padding: 60px 20px; color: #666; }
                  .empty-state h3 { font-size: 20px; margin-bottom: 12px; color: #333; }
                  .empty-state p { font-size: 16px; line-height: 1.5; }
                  
                  .progress-widget { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                  .progress-widget h3 { margin: 0 0 20px 0; font-size: 18px; color: #333; }
                  .progress-modules { display: flex; flex-direction: column; gap: 16px; }
                  .progress-module { display: flex; align-items: center; gap: 12px; }
                  .progress-bar { flex: 1; height: 8px; background: #f1f1f1; border-radius: 4px; overflow: hidden; }
                  .progress-fill { height: 100%; background: linear-gradient(90deg, #e60023, #ff4757); transition: width 0.3s ease; }
                  .progress-label { font-size: 14px; font-weight: 500; color: #333; min-width: 140px; }
                  .progress-value { font-size: 12px; color: #666; min-width: 40px; text-align: right; }
                  
                  .reporting-widget { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
                  .reporting-widget h3 { margin: 0 0 20px 0; font-size: 18px; color: #333; }
                  .reporting-table { width: 100%; border-collapse: collapse; }
                  .reporting-table th, .reporting-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #f1f1f1; }
                  .reporting-table th { background: #f8f9fa; font-weight: 600; color: #333; font-size: 14px; }
                  .reporting-table td { font-size: 13px; color: #666; }
                  .reporting-table tr:hover { background: #f8f9fa; }
                  .popularity-score { font-weight: 600; }
                  .popularity-high { color: #28a745; }
                  .popularity-medium { color: #ffc107; }
                  .popularity-low { color: #dc3545; }
                  
                  .hidden { display: none !important; }
              </style>
          </head>
          <body>
              <header class="header">
                  <div class="header-content">
                      <a href="#" class="logo">ExampleCorp.com</a>
                      <div class="nav-links">
                          <span class="nav-link active" data-tab="gallery">Gallery</span>
                          <span class="nav-link" data-tab="support">Support Tickets</span>
                          <span class="nav-link" data-tab="reports">Reports</span>
                      </div>
                      <div class="search-bar">
                          <input type="text" class="search-input" placeholder="Search for images..." id="searchInput">
                      </div>
                      <div style="width: 100px;"></div>
                  </div>
              </header>

              <div class="main-container">
                  <div id="galleryTab" class="tab-content">
                      <h1 class="page-title">Image Gallery</h1>
                      
                      <div id="loadingState" class="loading">
                          Loading amazing images...
                      </div>
                      
                      <div id="errorState" class="error" style="display: none;">
                          Failed to load images. Please try again later.
                      </div>
                      
                      <div id="imageGrid" class="horizontal-grid" style="display: none;">
                      </div>
                  </div>

                  <div id="supportTab" class="tab-content hidden">
                      <div class="support-container">
                          <h1 class="page-title">Support Tickets</h1>
                          
                          <!-- Support Actions Bar -->
                          <div style="background: white; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
                              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                  <button id="createTicketBtn" class="support-action-btn" style="
                                      background: linear-gradient(135deg, #28a745, #20c997);
                                      color: white; border: none; padding: 15px 20px; border-radius: 8px;
                                      font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                                      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
                                  ">
                                      ? Create Ticket
                                  </button>
                                  <button id="viewTicketsBtn" class="support-action-btn" style="
                                      background: linear-gradient(135deg, #17a2b8, #20c997);
                                      color: white; border: none; padding: 15px 20px; border-radius: 8px;
                                      font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                                      box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
                                  ">
                                      ?? View Tickets
                                  </button>
                                  <button id="correspondenceBtn" class="support-action-btn" style="
                                      background: linear-gradient(135deg, #6f42c1, #e83e8c);
                                      color: white; border: none; padding: 15px 20px; border-radius: 8px;
                                      font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                                      box-shadow: 0 4px 12px rgba(111, 66, 193, 0.3);
                                  ">
                                      ? Correspondence
                                  </button>
                                  <button id="manageTicketsBtn" class="support-action-btn" style="
                                      background: linear-gradient(135deg, #e60023, #ff4757);
                                      color: white; border: none; padding: 15px 20px; border-radius: 8px;
                                      font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                                      box-shadow: 0 4px 12px rgba(230, 0, 35, 0.3);
                                  ">
                                      ? Manage Tickets
                                  </button>
                              </div>
                          </div>
                          
                          <!-- Support Content Area -->
                          <div id="supportContent" style="background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); min-height: 400px;">
                              <div id="supportWelcome" style="text-align: center; padding: 40px 20px;">
                                  <h3 style="color: #333; margin-bottom: 15px;">? Support Ticket System</h3>
                                  <p style="color: #666; font-size: 16px; line-height: 1.6;">
                                      Select an action above to create, view, or manage support tickets.
                                  </p>
                              </div>
                              
                              <!-- Create Ticket Form -->
                              <div id="createTicketForm" style="display: none;">
                                  <h3 style="margin: 0 0 20px 0; color: #333;">? Create New Support Ticket</h3>
                                  <form id="ticketForm">
                                      <div style="margin-bottom: 20px;">
                                          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Subject:</label>
                                          <input type="text" id="ticketSubject" required style="
                                              width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;
                                              font-size: 16px; transition: border-color 0.3s ease;
                                          " placeholder="Brief description of the issue">
                                      </div>
                                      <div style="margin-bottom: 20px;">
                                          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Priority:</label>
                                          <select id="ticketPriority" style="
                                              width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;
                                              font-size: 16px; transition: border-color 0.3s ease;
                                          ">
                                              <option value="low">Low</option>
                                              <option value="medium" selected>Medium</option>
                                              <option value="high">High</option>
                                              <option value="sev1">Severity 1</option>
                                          </select>
                                      </div>
                                      <div style="margin-bottom: 20px;">
                                          <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Description:</label>
                                          <textarea id="ticketDescription" required rows="6" style="
                                              width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;
                                              font-size: 16px; transition: border-color 0.3s ease; resize: vertical;
                                          " placeholder="Detailed description of the issue, steps to reproduce, expected vs actual behavior..."></textarea>
                                      </div>
                                      <div style="display: flex; gap: 15px;">
                                          <button type="submit" style="
                                              background: linear-gradient(135deg, #28a745, #20c997);
                                              color: white; border: none; padding: 12px 24px; border-radius: 6px;
                                              font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                                          ">
                                              ? Create Ticket
                                          </button>
                                          <button type="button" id="cancelCreateBtn" style="
                                              background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px;
                                              font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
                                          ">
                                              Cancel
                                          </button>
                                      </div>
                                  </form>
                              </div>
                              
                              <!-- View Tickets List -->
                              <div id="viewTicketsList" style="display: none;">
                                  <h3 style="margin: 0 0 20px 0; color: #333;">?? Support Tickets</h3>
                                  <div id="ticketsContainer">
                                      <div style="text-align: center; padding: 40px; color: #666;">
                                          Loading tickets...
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- Ticket Details View -->
                              <div id="ticketDetailsView" style="display: none;">
                                  <div style="display: flex; align-items: center; margin-bottom: 20px;">
                                      <button id="backToListBtn" style="
                                          background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 6px;
                                          font-size: 14px; cursor: pointer; margin-right: 15px;
                                      ">
                                          ? Back to List
                                      </button>
                                      <h3 style="margin: 0; color: #333;">? Ticket Details</h3>
                                  </div>
                                  <div id="ticketDetailsContent">
                                      <!-- Ticket details will be populated here -->
                                  </div>
                              </div>
                              
                              <!-- Correspondence Management -->
                              <div id="correspondenceManagement" style="display: none;">
                                  <h3 style="margin: 0 0 20px 0; color: #333;">? Correspondence Management</h3>
                                  <div id="correspondenceContent">
                                      <p style="color: #666; text-align: center; padding: 40px;">
                                          Select a ticket to view and manage correspondence.
                                      </p>
                                  </div>
                              </div>
                              
                              <!-- Manage Tickets -->
                              <div id="manageTicketsView" style="display: none;">
                                  <h3 style="margin: 0 0 20px 0; color: #333;">? Manage Tickets</h3>
                                  <div id="manageTicketsContent">
                                      <div style="text-align: center; padding: 40px; color: #666;">
                                          Loading management interface...
                                      </div>
                                  </div>
                              </div>
                              
                              <!-- Loading State -->
                              <div id="supportLoading" style="display: none; text-align: center; padding: 40px;">
                                  <div style="display: inline-block; animation: spin 1s linear infinite; margin-right: 10px;">?</div>
                                  Processing request...
                              </div>
                              
                              <!-- Error State -->
                              <div id="supportError" style="display: none; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                  <!-- Error message will be displayed here -->
                              </div>
                          </div>
                      </div>
                  </div>

                  <div id="reportsTab" class="tab-content hidden">
                      <div class="support-container">
                          <h1 class="page-title">Analytics Reports</h1>
                          
                          <div style="max-width: 600px; margin: 0 auto; text-align: center; padding: 20px;">
                              <div style="background: white; border-radius: 16px; padding: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px;">
                                  <h3 style="margin: 0 0 15px 0; font-size: 20px; color: #333;">Generate Analytics Report</h3>
                                  <p style="margin-bottom: 20px; color: #666; font-size: 14px; line-height: 1.5;">
                                      Click the button below to fetch analytics data from the reporting server.
                                  </p>
                                  <button id="generateReportBtn" style="
                                      background: linear-gradient(135deg, #e60023, #ff4757);
                                      color: white;
                                      border: none;
                                      padding: 12px 24px;
                                      font-size: 16px;
                                      font-weight: 600;
                                      border-radius: 8px;
                                      cursor: pointer;
                                      transition: all 0.3s ease;
                                      box-shadow: 0 4px 12px rgba(230, 0, 35, 0.3);
                                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(230, 0, 35, 0.4)'" 
                                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(230, 0, 35, 0.3)'">
                                      ? Click to generate report
                                  </button>
                                  
                                  <div id="reportLoading" style="display: none; margin-top: 20px; color: #666;">
                                      <div style="display: inline-block; animation: spin 1s linear infinite; margin-right: 10px;">?</div>
                                      Fetching report from reporting server...
                                  </div>
                                  
                                  <div id="reportError" style="display: none; margin-top: 20px; padding: 15px; background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; border-radius: 8px; font-size: 14px;">
                                      <!-- Error message will be displayed here -->
                                  </div>
                              </div>
                          </div>
                          
                          <!-- Analytics Dashboard - Initially Hidden -->
                          <div id="analyticsDashboard" style="display: none;">
                              <!-- Summary Cards -->
                              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                                  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                                      <div style="font-size: 32px; font-weight: bold; color: #e60023; margin-bottom: 8px;" id="totalImages">0</div>
                                      <div style="font-size: 14px; color: #666; font-weight: 500;">Total Images</div>
                                  </div>
                                  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                                      <div style="font-size: 32px; font-weight: bold; color: #28a745; margin-bottom: 8px;" id="totalLikes">0</div>
                                      <div style="font-size: 14px; color: #666; font-weight: 500;">Total Likes</div>
                                  </div>
                                  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                                      <div style="font-size: 32px; font-weight: bold; color: #17a2b8; margin-bottom: 8px;" id="totalShares">0</div>
                                      <div style="font-size: 14px; color: #666; font-weight: 500;">Total Shares</div>
                                  </div>
                                  <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                                      <div style="font-size: 32px; font-weight: bold; color: #6f42c1; margin-bottom: 8px;" id="totalViews">0</div>
                                      <div style="font-size: 14px; color: #666; font-weight: 500;">Total Views</div>
                                  </div>
                              </div>


                              <!-- Detailed Analytics Table -->
                              <div style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                  <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                                      <h3 style="margin: 0; font-size: 18px; color: #333;">? Detailed Analytics</h3>
                                      <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                          Last updated: <span id="lastUpdatedTimestamp">Loading...</span>
                                      </div>
                                  </div>
                                  <div style="overflow-x: auto;">
                                      <table class="reporting-table" style="width: 100%; border-collapse: collapse;">
                                          <thead>
                                              <tr style="background: #f8f9fa;">
                                                  <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600;">Image</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Likes</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Shares</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Views</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Score</th>
                                                  <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600;">Last Updated</th>
                                              </tr>
                                          </thead>
                                          <tbody id="reportsTableBody">
                                              <tr>
                                                  <td colspan="6" style="padding: 40px; text-align: center; color: #666;">
                                                      Click "Generate Report" to load analytics data
                                                  </td>
                                              </tr>
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>

              <script>
                  const API_BASE_URL = window.location.origin;
                  let currentImages = [];
                  let currentTab = 'gallery';

                  document.querySelectorAll('[data-tab]').forEach(tab => {
                      tab.addEventListener('click', (e) => {
                          const tabName = e.target.getAttribute('data-tab');
                          switchTab(tabName);
                      });
                  });

                  function switchTab(tabName) {
                      document.querySelectorAll('.nav-link').forEach(link => {
                          link.classList.remove('active');
                      });
                      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                      document.querySelectorAll('.tab-content').forEach(content => {
                          content.classList.add('hidden');
                      });
                      document.getElementById(`${tabName}Tab`).classList.remove('hidden');

                      currentTab = tabName;

                      if (tabName === 'gallery') {
                          loadImages();
                      } else if (tabName === 'support') {
                          loadSupportTickets();
                      } else if (tabName === 'reports') {
                          loadReportsData();
                      }
                  }

                  async function loadImages() {
                      if (currentTab !== 'gallery') return;
                      
                      try {
                          showLoading();
                          const response = await fetch(`${API_BASE_URL}/api/images`);
                          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                          const images = await response.json();
                          currentImages = images;
                          displayImages(images);
                      } catch (error) {
                          console.error('Error loading images:', error);
                          showError();
                      }
                  }

                  function displayImages(images) {
                      const grid = document.getElementById('imageGrid');
                      grid.innerHTML = '';
                      images.forEach(image => {
                          const imageCard = createImageCard(image);
                          grid.appendChild(imageCard);
                      });
                      hideLoading();
                      grid.style.display = 'block';
                  }

                  function createImageCard(image) {
                      const card = document.createElement('div');
                      card.className = 'image-card';
                      card.setAttribute('data-image-id', image.id);
                      
                      const thumbnail = document.createElement('div');
                      thumbnail.className = 'image-thumbnail';
                      
                      const img = document.createElement('img');
                      img.src = image.image_url || 'https://via.placeholder.com/300x400?text=Image+Not+Available';
                      img.alt = image.title;
                      img.loading = 'lazy';
                      img.onerror = function() { this.src = 'https://via.placeholder.com/300x400?text=Image+Not+Available'; };
                      
                      const overlay = document.createElement('div');
                      overlay.className = 'image-overlay';
                      
                      const actions = document.createElement('div');
                      actions.className = 'image-actions';
                      
                      const likeBtn = document.createElement('button');
                      likeBtn.className = 'action-btn like-btn';
                      likeBtn.innerHTML = `? Like (${image.likes_count || 0})`;
                      likeBtn.onclick = (e) => {
                          e.stopPropagation();
                          trackInteraction(image.id, 'like', likeBtn);
                      };
                      
                      const shareBtn = document.createElement('button');
                      shareBtn.className = 'action-btn share-btn';
                      shareBtn.innerHTML = `? Share (${image.shares_count || 0})`;
                      shareBtn.onclick = (e) => {
                          e.stopPropagation();
                          trackInteraction(image.id, 'share', shareBtn);
                      };
                      
                      actions.appendChild(likeBtn);
                      actions.appendChild(shareBtn);
                      overlay.appendChild(actions);
                      
                      thumbnail.appendChild(img);
                      thumbnail.appendChild(overlay);
                      
                      const info = document.createElement('div');
                      info.className = 'image-info';
                      
                      const title = document.createElement('div');
                      title.className = 'image-title';
                      title.textContent = image.title;
                      
                      const description = document.createElement('div');
                      description.className = 'image-description';
                      description.textContent = image.description || 'No description available';
                      
                      const stats = document.createElement('div');
                      stats.className = 'image-stats';
                      
                      const likesCount = document.createElement('div');
                      likesCount.className = 'stat-item likes-count';
                      likesCount.innerHTML = `? ${image.likes_count || 0} likes`;
                      
                      const sharesCount = document.createElement('div');
                      sharesCount.className = 'stat-item shares-count';
                      sharesCount.innerHTML = `? ${image.shares_count || 0} shares`;
                      
                      const viewsCount = document.createElement('div');
                      viewsCount.className = 'stat-item views-count';
                      viewsCount.innerHTML = `? ${image.views_count || 0} views`;
                      
                      const dimensions = document.createElement('div');
                      dimensions.className = 'stat-item';
                      dimensions.innerHTML = `? ${image.width || '?'} ? ${image.height || '?'}`;
                      
                      const date = document.createElement('div');
                      date.className = 'stat-item';
                      const createdDate = new Date(image.created_at);
                      date.innerHTML = `? ${createdDate.toLocaleDateString()}`;
                      
                      stats.appendChild(likesCount);
                      stats.appendChild(sharesCount);
                      stats.appendChild(viewsCount);
                      stats.appendChild(dimensions);
                      stats.appendChild(date);
                      info.appendChild(title);
                      info.appendChild(description);
                      info.appendChild(stats);
                      
                      card.appendChild(thumbnail);
                      card.appendChild(info);
                      return card;
                  }

                  async function trackInteraction(imageId, action, buttonElement) {
                      try {
                          buttonElement.disabled = true;
                          const originalText = buttonElement.innerHTML;
                          buttonElement.innerHTML = `${action === 'like' ? '?' : '?'} ${action === 'like' ? 'Liking...' : 'Sharing...'}`;
                          
                          const response = await fetch(`${API_BASE_URL}/api/track/${action}`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  imageId: imageId,
                                  sessionId: 'user-session-' + Date.now()
                              })
                          });
                          
                          if (response.ok) {
                              console.log(`${action} tracked successfully for image ${imageId}`);
                              await refreshImageCounts(imageId);
                              buttonElement.innerHTML = `${action === 'like' ? '?' : '?'} ${action === 'like' ? 'Liked!' : 'Shared!'}`;
                              setTimeout(() => {
                                  buttonElement.disabled = false;
                              }, 1000);
                          } else {
                              throw new Error(`Failed to track ${action}`);
                          }
                      } catch (error) {
                          console.error(`Error tracking ${action}:`, error);
                          buttonElement.innerHTML = originalText;
                          buttonElement.disabled = false;
                      }
                  }

                  async function refreshImageCounts(imageId) {
                      try {
                          const response = await fetch(`${API_BASE_URL}/api/images`);
                          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                          const images = await response.json();
                          
                          const updatedImage = images.find(img => img.id === imageId);
                          if (updatedImage) {
                              updateImageCardCounts(imageId, updatedImage);
                          }
                          
                          // Also refresh reporting data if support tab is active
                          if (currentTab === 'support') {
                              loadReportingData();
                          }
                      } catch (error) {
                          console.error('Error refreshing image counts:', error);
                      }
                  }

                  function updateImageCardCounts(imageId, imageData) {
                      const card = document.querySelector(`[data-image-id="${imageId}"]`);
                      if (!card) return;
                      
                      const likeBtn = card.querySelector('.like-btn');
                      const shareBtn = card.querySelector('.share-btn');
                      
                      if (likeBtn && !likeBtn.disabled) {
                          likeBtn.innerHTML = `? Like (${imageData.likes_count || 0})`;
                      }
                      if (shareBtn && !shareBtn.disabled) {
                          shareBtn.innerHTML = `? Share (${imageData.shares_count || 0})`;
                      }
                      
                      const likesCount = card.querySelector('.likes-count');
                      const sharesCount = card.querySelector('.shares-count');
                      const viewsCount = card.querySelector('.views-count');
                      
                      if (likesCount) {
                          likesCount.innerHTML = `? ${imageData.likes_count || 0} likes`;
                      }
                      if (sharesCount) {
                          sharesCount.innerHTML = `? ${imageData.shares_count || 0} shares`;
                      }
                      if (viewsCount) {
                          viewsCount.innerHTML = `? ${imageData.views_count || 0} views`;
                      }
                  }

                  async function loadSupportTickets() {
                      const ticketsList = document.getElementById('ticketsList');
                      
                      // Clean version - no pre-populated tickets
                      ticketsList.innerHTML = `
                          <div class="empty-state">
                              <h3>No Support Tickets</h3>
                              <p>All systems are running normally. Support tickets will appear here when issues are detected by monitoring systems.</p>
                          </div>
                      `;

                      loadReportingData();
                  }

                  async function loadReportingData() {
                      const reportingTableBody = document.getElementById('reportingTableBody');
                      
                      try {
                          const response = await fetch(`${API_BASE_URL}/api/images`);
                          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                          const images = await response.json();
                          
                          reportingTableBody.innerHTML = '';
                          images.forEach(image => {
                              const tr = document.createElement('tr');
                              
                              const totalInteractions = (image.likes_count || 0) + (image.shares_count || 0);
                              const popularityScore = totalInteractions > 0 ? (totalInteractions / 10).toFixed(1) : '0.0';
                              
                              let popularityClass = 'popularity-low';
                              if (totalInteractions >= 10) {
                                  popularityClass = 'popularity-high';
                              } else if (totalInteractions >= 5) {
                                  popularityClass = 'popularity-medium';
                              }
                              
                              tr.innerHTML = `
                                  <td>${image.title}</td>
                                  <td>${image.likes_count || 0}</td>
                                  <td>${image.shares_count || 0}</td>
                                  <td><span class="popularity-score ${popularityClass}">${popularityScore}</span></td>
                              `;
                              
                              reportingTableBody.appendChild(tr);
                          });
                      } catch (error) {
                          console.error('Error loading reporting data:', error);
                          reportingTableBody.innerHTML = '<tr><td colspan="4">Error loading data</td></tr>';
                      }
                  }

                  function showLoading() {
                      document.getElementById('loadingState').style.display = 'block';
                      document.getElementById('errorState').style.display = 'none';
                      document.getElementById('imageGrid').style.display = 'none';
                  }

                  function showError() {
                      document.getElementById('loadingState').style.display = 'none';
                      document.getElementById('errorState').style.display = 'block';
                      document.getElementById('imageGrid').style.display = 'none';
                  }

                  async function loadReportsData() {
                      const reportsTableBody = document.getElementById('reportsTableBody');
                      const totalLikes = document.getElementById('totalLikes');
                      const totalShares = document.getElementById('totalShares');
                      const totalViews = document.getElementById('totalViews');
                      const totalImages = document.getElementById('totalImages');
                      
                      try {
                          // First try to get analytics report from reporting server
                          let analyticsData = null;
                          try {
                              const analyticsResponse = await fetch(`${API_BASE_URL}/api/analytics/report`);
                              if (analyticsResponse.ok) {
                                  analyticsData = await analyticsResponse.json();
                              }
                          } catch (error) {
                              console.log('Analytics report not available, falling back to direct image data');
                          }
                          
                          // If no analytics report, get direct image data
                          if (!analyticsData || !analyticsData.images || analyticsData.images.length === 0) {
                              const response = await fetch(`${API_BASE_URL}/api/images`);
                              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                              const images = await response.json();
                              
                              // Create analytics data from images
                              analyticsData = {
                                  images: images,
                                  total_images: images.length,
                                  total_likes: images.reduce((sum, img) => sum + (img.likes_count || 0), 0),
                                  total_shares: images.reduce((sum, img) => sum + (img.shares_count || 0), 0),
                                  total_views: images.reduce((sum, img) => sum + (img.views_count || 0), 0),
                                  generated_at: new Date().toISOString(),
                                  update_source: 'direct-query'
                              };
                          }
                          
                          // Update summary cards
                          totalLikes.textContent = analyticsData.total_likes || 0;
                          totalShares.textContent = analyticsData.total_shares || 0;
                          totalViews.textContent = analyticsData.total_views || 0;
                          totalImages.textContent = analyticsData.total_images || 0;
                          
                          // Update timestamp
                          const lastUpdatedTimestamp = document.getElementById('lastUpdatedTimestamp');
                          if (analyticsData.last_updated) {
                              const updateTime = new Date(analyticsData.last_updated);
                              lastUpdatedTimestamp.textContent = updateTime.toLocaleString();
                          } else {
                              lastUpdatedTimestamp.textContent = 'Not available';
                          }
                          
                          
                          // Update reports table
                          reportsTableBody.innerHTML = '';
                          if (analyticsData.images && analyticsData.images.length > 0) {
                              analyticsData.images.forEach(image => {
                                  const tr = document.createElement('tr');
                                  
                                  const totalInteractions = (image.likes_count || 0) + (image.shares_count || 0);
                                  const popularityScore = totalInteractions > 0 ? (totalInteractions / 10).toFixed(1) : '0.0';
                                  
                                  let popularityClass = 'popularity-low';
                                  if (totalInteractions >= 10) {
                                      popularityClass = 'popularity-high';
                                  } else if (totalInteractions >= 5) {
                                      popularityClass = 'popularity-medium';
                                  }
                                  
                                  const lastUpdated = image.updated_at ? 
                                      new Date(image.updated_at).toLocaleString() : 
                                      'N/A';
                                  
                                  tr.innerHTML = `
                                      <td>${image.title}</td>
                                      <td>${image.likes_count || 0}</td>
                                      <td>${image.shares_count || 0}</td>
                                      <td>${image.views_count || 0}</td>
                                      <td><span class="popularity-score ${popularityClass}">${popularityScore}</span></td>
                                      <td>${lastUpdated}</td>
                                  `;
                                  
                                  reportsTableBody.appendChild(tr);
                              });
                          } else {
                              reportsTableBody.innerHTML = `
                                  <tr>
                                      <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                          No analytics data available yet. Try interacting with images in the Gallery tab.
                                      </td>
                                  </tr>
                              `;
                          }
                          
                          console.log('Reports data loaded successfully');
                          
                      } catch (error) {
                          console.error('Error loading reports data:', error);
                          reportsTableBody.innerHTML = `
                              <tr>
                                  <td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">
                                      Error loading analytics data: ${error.message}
                                  </td>
                              </tr>
                          `;
                          
                          // Reset summary cards on error
                          totalLikes.textContent = '-';
                          totalShares.textContent = '-';
                          totalViews.textContent = '-';
                          totalImages.textContent = '-';
                      }
                  }

                  function hideLoading() {
                      document.getElementById('loadingState').style.display = 'none';
                      document.getElementById('errorState').style.display = 'none';
                  }

                  async function loadReportsData() {
                      const reportsTableBody = document.getElementById('reportsTableBody');
                      const totalLikes = document.getElementById('totalLikes');
                      const totalShares = document.getElementById('totalShares');
                      const totalViews = document.getElementById('totalViews');
                      const totalImages = document.getElementById('totalImages');
                      
                      try {
                          // First try to get analytics report from reporting server
                          let analyticsData = null;
                          try {
                              const analyticsResponse = await fetch(`${API_BASE_URL}/api/analytics/report`);
                              if (analyticsResponse.ok) {
                                  analyticsData = await analyticsResponse.json();
                              }
                          } catch (error) {
                              console.log('Analytics report not available, falling back to direct image data');
                          }
                          
                          // If no analytics report, get direct image data
                          if (!analyticsData || !analyticsData.images || analyticsData.images.length === 0) {
                              const response = await fetch(`${API_BASE_URL}/api/images`);
                              if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                              const images = await response.json();
                              
                              // Create analytics data from images
                              analyticsData = {
                                  images: images,
                                  total_images: images.length,
                                  total_likes: images.reduce((sum, img) => sum + (img.likes_count || 0), 0),
                                  total_shares: images.reduce((sum, img) => sum + (img.shares_count || 0), 0),
                                  total_views: images.reduce((sum, img) => sum + (img.views_count || 0), 0),
                                  generated_at: new Date().toISOString(),
                                  update_source: 'direct-query'
                              };
                          }
                          
                          // Update summary cards
                          totalLikes.textContent = analyticsData.total_likes || 0;
                          totalShares.textContent = analyticsData.total_shares || 0;
                          totalViews.textContent = analyticsData.total_views || 0;
                          totalImages.textContent = analyticsData.total_images || 0;
                          
                          // Update reports table
                          reportsTableBody.innerHTML = '';
                          if (analyticsData.images && analyticsData.images.length > 0) {
                              analyticsData.images.forEach(image => {
                                  const tr = document.createElement('tr');
                                  
                                  const totalInteractions = (image.likes_count || 0) + (image.shares_count || 0);
                                  const popularityScore = totalInteractions > 0 ? (totalInteractions / 10).toFixed(1) : '0.0';
                                  
                                  let popularityClass = 'popularity-low';
                                  if (totalInteractions >= 10) {
                                      popularityClass = 'popularity-high';
                                  } else if (totalInteractions >= 5) {
                                      popularityClass = 'popularity-medium';
                                  }
                                  
                                  const lastUpdated = image.updated_at ? 
                                      new Date(image.updated_at).toLocaleString() : 
                                      'N/A';
                                  
                                  tr.innerHTML = `
                                      <td>${image.title}</td>
                                      <td>${image.likes_count || 0}</td>
                                      <td>${image.shares_count || 0}</td>
                                      <td>${image.views_count || 0}</td>
                                      <td><span class="popularity-score ${popularityClass}">${popularityScore}</span></td>
                                      <td>${lastUpdated}</td>
                                  `;
                                  
                                  reportsTableBody.appendChild(tr);
                              });
                          } else {
                              reportsTableBody.innerHTML = `
                                  <tr>
                                      <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                          No analytics data available yet. Try interacting with images in the Gallery tab.
                                      </td>
                                  </tr>
                              `;
                          }
                          
                          console.log('Reports data loaded successfully');
                          
                      } catch (error) {
                          console.error('Error loading reports data:', error);
                          reportsTableBody.innerHTML = `
                              <tr>
                                  <td colspan="6" style="text-align: center; padding: 40px; color: #dc3545;">
                                      Error loading analytics data: ${error.message}
                                  </td>
                              </tr>
                          `;
                          
                          // Reset summary cards on error
                          totalLikes.textContent = '-';
                          totalShares.textContent = '-';
                          totalViews.textContent = '-';
                          totalImages.textContent = '-';
                      }
                  }

                  // Add event listener for the Generate Report button
                  document.addEventListener('DOMContentLoaded', () => {
                      loadImages();
                      
                      // Add click handler for Generate Report button
                      const generateReportBtn = document.getElementById('generateReportBtn');
                      if (generateReportBtn) {
                          generateReportBtn.addEventListener('click', async () => {
                              await generateReport();
                          });
                      }
                      
                      // Add click handlers for Support Ticket functionality
                      const createTicketBtn = document.getElementById('createTicketBtn');
                      const viewTicketsBtn = document.getElementById('viewTicketsBtn');
                      const correspondenceBtn = document.getElementById('correspondenceBtn');
                      const manageTicketsBtn = document.getElementById('manageTicketsBtn');
                      
                      if (createTicketBtn) {
                          createTicketBtn.addEventListener('click', () => showCreateTicketForm());
                      }
                      if (viewTicketsBtn) {
                          viewTicketsBtn.addEventListener('click', () => showViewTickets());
                      }
                      if (correspondenceBtn) {
                          correspondenceBtn.addEventListener('click', () => showCorrespondenceManagement());
                      }
                      if (manageTicketsBtn) {
                          manageTicketsBtn.addEventListener('click', () => showManageTickets());
                      }
                      
                      // Add form handlers
                      const ticketForm = document.getElementById('ticketForm');
                      if (ticketForm) {
                          ticketForm.addEventListener('submit', handleCreateTicket);
                      }
                      
                      const cancelCreateBtn = document.getElementById('cancelCreateBtn');
                      if (cancelCreateBtn) {
                          cancelCreateBtn.addEventListener('click', () => showSupportWelcome());
                      }
                      
                      const backToListBtn = document.getElementById('backToListBtn');
                      if (backToListBtn) {
                          backToListBtn.addEventListener('click', () => showViewTickets());
                      }
                  });

                  // Function to generate report by fetching from reporting server
                  async function generateReport() {
                      const reportLoading = document.getElementById('reportLoading');
                      const reportError = document.getElementById('reportError');
                      const generateReportBtn = document.getElementById('generateReportBtn');
                      const analyticsDashboard = document.getElementById('analyticsDashboard');
                      
                      // Hide previous content and show loading
                      analyticsDashboard.style.display = 'none';
                      reportError.style.display = 'none';
                      reportLoading.style.display = 'block';
                      generateReportBtn.disabled = true;
                      generateReportBtn.innerHTML = '? Generating...';
                      
                      try {
                          // Try to fetch from the reporting server
                          let reportData = null;
                          
                          // Use the Lambda proxy endpoint instead of direct reporting server access
                          console.log('Fetching analytics report via Lambda proxy...');
                          const response = await fetch(`${API_BASE_URL}/api/proxy`);
                          if (response.ok) {
                              reportData = await response.json();
                              console.log('Successfully received analytics data via proxy');
                          } else {
                              const errorText = await response.text();
                              throw new Error(`Proxy endpoint failed: HTTP ${response.status} - ${errorText}`);
                          }
                          
                          // Update the analytics dashboard with the fetched data
                          if (reportData && reportData.images) {
                              updateAnalyticsDashboard(reportData);
                              
                              // Show the analytics dashboard
                              analyticsDashboard.style.display = 'block';
                              reportLoading.style.display = 'none';
                              
                              // Update button
                              generateReportBtn.disabled = false;
                              generateReportBtn.innerHTML = '? Report Generated';
                              
                              // Reset button text after 3 seconds
                              setTimeout(() => {
                                  generateReportBtn.innerHTML = '? Click to generate report';
                              }, 3000);
                          } else {
                              throw new Error('No valid data received from reporting server');
                          }
                          
                      } catch (error) {
                          console.error('Error generating report:', error);
                          
                          // Show error message
                          reportError.innerHTML = `
                              <h4>Failed to Generate Report</h4>
                              <p><strong>Error:</strong> ${error.message}</p>
                              <p>The reporting server may be unavailable or there may be a network connectivity issue.</p>
                              <p><strong>Troubleshooting:</strong></p>
                              <ul>
                                  <li>Check if the reporting server is running</li>
                                  <li>Verify network connectivity between VPCs</li>
                                  <li>Ensure the reporting server analytics API is accessible</li>
                              </ul>
                          `;
                          reportError.style.display = 'block';
                          reportLoading.style.display = 'none';
                          
                          // Reset button
                          generateReportBtn.disabled = false;
                          generateReportBtn.innerHTML = '? Retry Report Generation';
                      }
                  }

                  // Function to update the analytics dashboard with fetched data
                  function updateAnalyticsDashboard(data) {
                      // Update summary cards
                      document.getElementById('totalImages').textContent = data.total_images || 0;
                      document.getElementById('totalLikes').textContent = data.total_likes || 0;
                      document.getElementById('totalShares').textContent = data.total_shares || 0;
                      document.getElementById('totalViews').textContent = data.total_views || 0;
                      
                      // Update timestamp
                      const lastUpdatedTimestamp = document.getElementById('lastUpdatedTimestamp');
                      if (data.generated_at) {
                          const updateTime = new Date(data.generated_at);
                          lastUpdatedTimestamp.textContent = updateTime.toLocaleString();
                      } else {
                          lastUpdatedTimestamp.textContent = 'Just now';
                      }
                      
                      
                      // Update detailed analytics table
                      const reportsTableBody = document.getElementById('reportsTableBody');
                      reportsTableBody.innerHTML = '';
                      
                      if (data.images && data.images.length > 0) {
                          data.images.forEach(image => {
                              const tr = document.createElement('tr');
                              
                              const totalInteractions = (image.likes_count || 0) + (image.shares_count || 0);
                              const popularityScore = totalInteractions > 0 ? (totalInteractions / 10).toFixed(1) : '0.0';
                              
                              let popularityClass = 'popularity-low';
                              if (totalInteractions >= 10) {
                                  popularityClass = 'popularity-high';
                              } else if (totalInteractions >= 5) {
                                  popularityClass = 'popularity-medium';
                              }
                              
                              const lastUpdated = image.updated_at ? 
                                  new Date(image.updated_at).toLocaleString() : 
                                  'N/A';
                              
                              tr.innerHTML = `
                                  <td>${image.title}</td>
                                  <td>${image.likes_count || 0}</td>
                                  <td>${image.shares_count || 0}</td>
                                  <td>${image.views_count || 0}</td>
                                  <td><span class="popularity-score ${popularityClass}">${popularityScore}</span></td>
                                  <td>${lastUpdated}</td>
                              `;
                              
                              reportsTableBody.appendChild(tr);
                          });
                      } else {
                          reportsTableBody.innerHTML = `
                              <tr>
                                  <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                                      No analytics data available.
                                  </td>
                              </tr>
                          `;
                      }
                  }

                  // Support Ticket JavaScript Functions
                  let supportApiUrl = '';
                  
                  // Initialize support ticket functionality
                  async function initializeSupportTickets() {
                      try {
                          const response = await fetch(`${API_BASE_URL}/api/support/gateway-url`);
                          if (response.ok) {
                              const data = await response.json();
                              supportApiUrl = data.gateway_url;
                              console.log('Support API Gateway URL loaded:', supportApiUrl);
                          } else {
                              console.error('Failed to load support API Gateway URL');
                          }
                      } catch (error) {
                          console.error('Error loading support API Gateway URL:', error);
                      }
                  }
                  
                  // Show different support sections
                  function showSupportWelcome() {
                      hideAllSupportSections();
                      document.getElementById('supportWelcome').style.display = 'block';
                  }
                  
                  function showCreateTicketForm() {
                      hideAllSupportSections();
                      document.getElementById('createTicketForm').style.display = 'block';
                  }
                  
                  function showViewTickets() {
                      hideAllSupportSections();
                      document.getElementById('viewTicketsList').style.display = 'block';
                      loadTicketsList();
                  }
                  
                  function showCorrespondenceManagement() {
                      hideAllSupportSections();
                      document.getElementById('correspondenceManagement').style.display = 'block';
                      loadCorrespondenceTickets();
                  }
                  
                  function showManageTickets() {
                      hideAllSupportSections();
                      document.getElementById('manageTicketsView').style.display = 'block';
                      loadManageTickets();
                  }
                  
                  function hideAllSupportSections() {
                      document.getElementById('supportWelcome').style.display = 'none';
                      document.getElementById('createTicketForm').style.display = 'none';
                      document.getElementById('viewTicketsList').style.display = 'none';
                      document.getElementById('ticketDetailsView').style.display = 'none';
                      document.getElementById('correspondenceManagement').style.display = 'none';
                      document.getElementById('manageTicketsView').style.display = 'none';
                      document.getElementById('supportLoading').style.display = 'none';
                      document.getElementById('supportError').style.display = 'none';
                  }
                  
                  function showSupportLoading() {
                      hideAllSupportSections();
                      document.getElementById('supportLoading').style.display = 'block';
                  }
                  
                  function showSupportError(message) {
                      hideAllSupportSections();
                      document.getElementById('supportError').innerHTML = `
                          <h4>Error</h4>
                          <p>${message}</p>
                          <button onclick="showSupportWelcome()" style="
                              background: #6c757d; color: white; border: none; padding: 8px 16px; 
                              border-radius: 4px; cursor: pointer; margin-top: 10px;
                          ">Back to Support Home</button>
                      `;
                      document.getElementById('supportError').style.display = 'block';
                  }
                  
                  // Handle create ticket form submission
                  async function handleCreateTicket(event) {
                      event.preventDefault();
                      
                      const subject = document.getElementById('ticketSubject').value;
                      const priority = document.getElementById('ticketPriority').value;
                      const description = document.getElementById('ticketDescription').value;
                      
                      if (!subject || !description) {
                          showSupportError('Please fill in all required fields.');
                          return;
                      }
                      
                      // Ensure supportApiUrl is loaded before making requests
                      if (!supportApiUrl) {
                          await initializeSupportTickets();
                      }
                      
                      if (!supportApiUrl) {
                          showSupportError('Support API Gateway URL not available. Please check system configuration.');
                          return;
                      }
                      
                      showSupportLoading();
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  subject: subject,
                                  priority: priority,
                                  description: description
                              })
                          });
                          
                          if (response.ok) {
                              const result = await response.json();
                              
                              // Show success message and reset form
                              document.getElementById('ticketForm').reset();
                              
                              hideAllSupportSections();
                              document.getElementById('supportContent').innerHTML = `
                                  <div style="text-align: center; padding: 40px;">
                                      <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                          <h3 style="margin: 0 0 10px 0;">? Ticket Created Successfully!</h3>
                                          <p style="margin: 0;">Ticket ID: <strong>${result.ticket.id}</strong></p>
                                          <p style="margin: 5px 0 0 0;">Subject: <strong>${result.ticket.subject}</strong></p>
                                      </div>
                                      <button onclick="showViewTickets()" style="
                                          background: linear-gradient(135deg, #17a2b8, #20c997);
                                          color: white; border: none; padding: 12px 24px; border-radius: 6px;
                                          font-size: 16px; font-weight: 600; cursor: pointer; margin-right: 15px;
                                      ">View All Tickets</button>
                                      <button onclick="showSupportWelcome()" style="
                                          background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px;
                                          font-size: 16px; font-weight: 600; cursor: pointer;
                                      ">Back to Support Home</button>
                                  </div>
                              `;
                          } else {
                              const error = await response.json();
                              showSupportError(`Failed to create ticket: ${error.error || 'Unknown error'}`);
                          }
                      } catch (error) {
                          console.error('Error creating ticket:', error);
                          showSupportError(`Network error: ${error.message}`);
                      }
                  }
                  
                  // Load tickets list
                  async function loadTicketsList() {
                      const container = document.getElementById('ticketsContainer');
                      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading tickets...</div>';
                      
                      // Ensure supportApiUrl is loaded before making requests
                      if (!supportApiUrl) {
                          await initializeSupportTickets();
                      }
                      
                      if (!supportApiUrl) {
                          container.innerHTML = `
                              <div style="text-align: center; padding: 40px; color: #dc3545;">
                                  <h4>Configuration Error</h4>
                                  <p>Support API Gateway URL not available. Please check system configuration.</p>
                              </div>
                          `;
                          return;
                      }
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets`);
                          
                          if (response.ok) {
                              const result = await response.json();
                              const tickets = result.tickets || [];
                              
                              if (tickets.length === 0) {
                                  container.innerHTML = `
                                      <div style="text-align: center; padding: 40px; color: #666;">
                                          <h4>No Support Tickets</h4>
                                          <p>No tickets have been created yet.</p>
                                          <button onclick="showCreateTicketForm()" style="
                                              background: linear-gradient(135deg, #28a745, #20c997);
                                              color: white; border: none; padding: 12px 24px; border-radius: 6px;
                                              font-size: 16px; font-weight: 600; cursor: pointer;
                                          ">Create First Ticket</button>
                                      </div>
                                  `;
                              } else {
                                  let ticketsHtml = '<div style="display: grid; gap: 15px;">';
                                  
                                  tickets.forEach(ticket => {
                                      const createdDate = new Date(ticket.created_at).toLocaleString();
                                      const statusColor = ticket.status === 'open' ? '#28a745' : 
                                                         ticket.status === 'in_progress' ? '#ffc107' : '#6c757d';
                                      const priorityColor = ticket.priority === 'sev1' ? '#dc3545' :
                                                           ticket.priority === 'high' ? '#fd7e14' :
                                                           ticket.priority === 'medium' ? '#ffc107' : '#28a745';
                                      
                                      ticketsHtml += `
                                          <div style="
                                              background: white; border: 1px solid #dee2e6; border-radius: 8px; 
                                              padding: 20px; cursor: pointer; transition: all 0.3s ease;
                                              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                                          " onclick="viewTicketDetails('${ticket.id}')" 
                                             onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'"
                                             onmouseout="this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                                  <h4 style="margin: 0; color: #333; font-size: 16px;">${ticket.subject}</h4>
                                                  <div style="display: flex; gap: 8px;">
                                                      <span style="
                                                          background: ${statusColor}; color: white; padding: 4px 8px; 
                                                          border-radius: 12px; font-size: 12px; font-weight: 600;
                                                      ">${ticket.status.replace('_', ' ').toUpperCase()}</span>
                                                      <span style="
                                                          background: ${priorityColor}; color: white; padding: 4px 8px; 
                                                          border-radius: 12px; font-size: 12px; font-weight: 600;
                                                      ">${ticket.priority.toUpperCase()}</span>
                                                  </div>
                                              </div>
                                              <p style="margin: 0 0 10px 0; color: #666; font-size: 14px; line-height: 1.4;">
                                                  ${ticket.description.length > 150 ? 
                                                    ticket.description.substring(0, 150) + '...' : 
                                                    ticket.description}
                                              </p>
                                              <div style="font-size: 12px; color: #999;">
                                                  <strong>ID:</strong> ${ticket.id.substring(0, 8)}... | 
                                                  <strong>Created:</strong> ${createdDate}
                                              </div>
                                          </div>
                                      `;
                                  });
                                  
                                  ticketsHtml += '</div>';
                                  container.innerHTML = ticketsHtml;
                              }
                          } else {
                              const error = await response.json();
                              container.innerHTML = `
                                  <div style="text-align: center; padding: 40px; color: #dc3545;">
                                      <h4>Error Loading Tickets</h4>
                                      <p>${error.error || 'Failed to load tickets'}</p>
                                  </div>
                              `;
                          }
                      } catch (error) {
                          console.error('Error loading tickets:', error);
                          container.innerHTML = `
                              <div style="text-align: center; padding: 40px; color: #dc3545;">
                                  <h4>Network Error</h4>
                                  <p>Failed to connect to support system: ${error.message}</p>
                              </div>
                          `;
                      }
                  }
                  
                  // View ticket details
                  async function viewTicketDetails(ticketId) {
                      hideAllSupportSections();
                      document.getElementById('ticketDetailsView').style.display = 'block';
                      
                      const container = document.getElementById('ticketDetailsContent');
                      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading ticket details...</div>';
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets/${ticketId}`);
                          
                          if (response.ok) {
                              const result = await response.json();
                              const ticket = result.ticket;
                              
                              const createdDate = new Date(ticket.created_at).toLocaleString();
                              const updatedDate = new Date(ticket.updated_at).toLocaleString();
                              
                              const statusColor = ticket.status === 'open' ? '#28a745' : 
                                                 ticket.status === 'in_progress' ? '#ffc107' : '#6c757d';
                              const priorityColor = ticket.priority === 'sev1' ? '#dc3545' :
                                                   ticket.priority === 'high' ? '#fd7e14' :
                                                   ticket.priority === 'medium' ? '#ffc107' : '#28a745';
                              
                              let detailsHtml = `
                                  <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                          <h3 style="margin: 0; color: #333;">${ticket.subject}</h3>
                                          <div style="display: flex; gap: 8px;">
                                              <span style="
                                                  background: ${statusColor}; color: white; padding: 6px 12px; 
                                                  border-radius: 15px; font-size: 14px; font-weight: 600;
                                              ">${ticket.status.replace('_', ' ').toUpperCase()}</span>
                                              <span style="
                                                  background: ${priorityColor}; color: white; padding: 6px 12px; 
                                                  border-radius: 15px; font-size: 14px; font-weight: 600;
                                              ">${ticket.priority.toUpperCase()}</span>
                                          </div>
                                      </div>
                                      
                                      <div style="margin-bottom: 15px;">
                                          <strong>Description:</strong>
                                          <p style="margin: 8px 0; padding: 15px; background: #f8f9fa; border-radius: 6px; line-height: 1.5;">
                                              ${ticket.description}
                                          </p>
                                      </div>
                                      
                                      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px; color: #666;">
                                          <div><strong>Ticket ID:</strong> ${ticket.id}</div>
                                          <div><strong>Created:</strong> ${createdDate}</div>
                                          <div><strong>Last Updated:</strong> ${updatedDate}</div>
                                      </div>
                                  </div>
                              `;
                              
                              // Add correspondence section
                              if (ticket.correspondence && ticket.correspondence.length > 0) {
                                  detailsHtml += `
                                      <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                                          <h4 style="margin: 0 0 15px 0; color: #333;">? Correspondence</h4>
                                          <div style="display: flex; flex-direction: column; gap: 15px;">
                                  `;
                                  
                                  ticket.correspondence.forEach(message => {
                                      const messageDate = new Date(message.created_at).toLocaleString();
                                      const messageTypeColor = message.message_type === 'system' ? '#17a2b8' :
                                                              message.message_type === 'agent' ? '#28a745' : '#6f42c1';
                                      
                                      detailsHtml += `
                                          <div style="
                                              border-left: 4px solid ${messageTypeColor}; 
                                              padding: 15px; background: #f8f9fa; border-radius: 0 6px 6px 0;
                                          ">
                                              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                                  <strong style="color: ${messageTypeColor};">${message.author}</strong>
                                                  <span style="font-size: 12px; color: #666;">${messageDate}</span>
                                              </div>
                                              <p style="margin: 0; line-height: 1.5;">${message.message}</p>
                                          </div>
                                      `;
                                  });
                                  
                                  detailsHtml += '</div></div>';
                              }
                              
                              // Add correspondence form
                              detailsHtml += `
                                  <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px;">
                                      <h4 style="margin: 0 0 15px 0; color: #333;">Add Response</h4>
                                      <form onsubmit="addCorrespondence(event, '${ticket.id}')">
                                          <div style="margin-bottom: 15px;">
                                              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Your Name:</label>
                                              <input type="text" id="correspondenceAuthor" required style="
                                                  width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px;
                                                  font-size: 14px;
                                              " placeholder="Enter your name" value="Support User">
                                          </div>
                                          <div style="margin-bottom: 15px;">
                                              <label style="display: block; margin-bottom: 8px; font-weight: 600;">Message:</label>
                                              <textarea id="correspondenceMessage" required rows="4" style="
                                                  width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px;
                                                  font-size: 14px; resize: vertical;
                                              " placeholder="Enter your response or additional information..."></textarea>
                                          </div>
                                          <div style="display: flex; gap: 10px;">
                                              <button type="submit" style="
                                                  background: linear-gradient(135deg, #6f42c1, #e83e8c);
                                                  color: white; border: none; padding: 10px 20px; border-radius: 6px;
                                                  font-size: 14px; font-weight: 600; cursor: pointer;
                                              ">Add Response</button>
                                              <button type="button" onclick="updateTicketStatus('${ticket.id}', 'closed')" style="
                                                  background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 6px;
                                                  font-size: 14px; font-weight: 600; cursor: pointer;
                                              ">Close Ticket</button>
                                          </div>
                                      </form>
                                  </div>
                              `;
                              
                              container.innerHTML = detailsHtml;
                          } else {
                              const error = await response.json();
                              container.innerHTML = `
                                  <div style="text-align: center; padding: 40px; color: #dc3545;">
                                      <h4>Error Loading Ticket</h4>
                                      <p>${error.error || 'Failed to load ticket details'}</p>
                                  </div>
                              `;
                          }
                      } catch (error) {
                          console.error('Error loading ticket details:', error);
                          container.innerHTML = `
                              <div style="text-align: center; padding: 40px; color: #dc3545;">
                                  <h4>Network Error</h4>
                                  <p>Failed to connect to support system: ${error.message}</p>
                              </div>
                          `;
                      }
                  }
                  
                  // Add correspondence to ticket
                  async function addCorrespondence(event, ticketId) {
                      event.preventDefault();
                      
                      const author = document.getElementById('correspondenceAuthor').value;
                      const message = document.getElementById('correspondenceMessage').value;
                      
                      if (!author || !message) {
                          alert('Please fill in all fields.');
                          return;
                      }
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets/${ticketId}/correspondence`, {
                              method: 'POST',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  author: author,
                                  message: message,
                                  message_type: 'user'
                              })
                          });
                          
                          if (response.ok) {
                              // Reload ticket details to show new correspondence
                              viewTicketDetails(ticketId);
                          } else {
                              const error = await response.json();
                              alert(`Failed to add response: ${error.error || 'Unknown error'}`);
                          }
                      } catch (error) {
                          console.error('Error adding correspondence:', error);
                          alert(`Network error: ${error.message}`);
                      }
                  }
                  
                  // Update ticket status
                  async function updateTicketStatus(ticketId, newStatus) {
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets/${ticketId}`, {
                              method: 'PUT',
                              headers: {
                                  'Content-Type': 'application/json',
                              },
                              body: JSON.stringify({
                                  status: newStatus
                              })
                          });
                          
                          if (response.ok) {
                              // Reload ticket details to show updated status
                              viewTicketDetails(ticketId);
                          } else {
                              const error = await response.json();
                              alert(`Failed to update ticket: ${error.error || 'Unknown error'}`);
                          }
                      } catch (error) {
                          console.error('Error updating ticket:', error);
                          alert(`Network error: ${error.message}`);
                      }
                  }
                  
                  // Load correspondence tickets
                  async function loadCorrespondenceTickets() {
                      const container = document.getElementById('correspondenceContent');
                      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading tickets with correspondence...</div>';
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets`);
                          
                          if (response.ok) {
                              const result = await response.json();
                              const tickets = result.tickets || [];
                              
                              // Filter tickets that have correspondence
                              const ticketsWithCorrespondence = tickets.filter(ticket => 
                                  ticket.correspondence && ticket.correspondence.length > 0
                              );
                              
                              if (ticketsWithCorrespondence.length === 0) {
                                  container.innerHTML = `
                                      <div style="text-align: center; padding: 40px; color: #666;">
                                          <h4>No Correspondence Available</h4>
                                          <p>No tickets have correspondence messages yet.</p>
                                      </div>
                                  `;
                              } else {
                                  let correspondenceHtml = '<div style="display: grid; gap: 15px;">';
                                  
                                  ticketsWithCorrespondence.forEach(ticket => {
                                      const messageCount = ticket.correspondence ? ticket.correspondence.length : 0;
                                      const lastMessage = ticket.correspondence && ticket.correspondence.length > 0 ? 
                                          ticket.correspondence[ticket.correspondence.length - 1] : null;
                                      
                                      correspondenceHtml += `
                                          <div style="
                                              background: white; border: 1px solid #dee2e6; border-radius: 8px; 
                                              padding: 20px; cursor: pointer; transition: all 0.3s ease;
                                          " onclick="viewTicketDetails('${ticket.id}')">
                                              <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                                  <h4 style="margin: 0; color: #333; font-size: 16px;">${ticket.subject}</h4>
                                                  <span style="
                                                      background: #6f42c1; color: white; padding: 4px 8px; 
                                                      border-radius: 12px; font-size: 12px; font-weight: 600;
                                                  ">${messageCount} Messages</span>
                                              </div>
                                              ${lastMessage ? `
                                                  <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                                      <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                                          Last message by <strong>${lastMessage.author}</strong>
                                                      </div>
                                                      <p style="margin: 0; font-size: 14px; color: #333;">
                                                          ${lastMessage.message.length > 100 ? 
                                                            lastMessage.message.substring(0, 100) + '...' : 
                                                            lastMessage.message}
                                                      </p>
                                                  </div>
                                              ` : ''}
                                              <div style="font-size: 12px; color: #999;">
                                                  <strong>ID:</strong> ${ticket.id.substring(0, 8)}... | 
                                                  <strong>Status:</strong> ${ticket.status.replace('_', ' ').toUpperCase()}
                                              </div>
                                          </div>
                                      `;
                                  });
                                  
                                  correspondenceHtml += '</div>';
                                  container.innerHTML = correspondenceHtml;
                              }
                          } else {
                              const error = await response.json();
                              container.innerHTML = `
                                  <div style="text-align: center; padding: 40px; color: #dc3545;">
                                      <h4>Error Loading Correspondence</h4>
                                      <p>${error.error || 'Failed to load correspondence'}</p>
                                  </div>
                              `;
                          }
                      } catch (error) {
                          console.error('Error loading correspondence:', error);
                          container.innerHTML = `
                              <div style="text-align: center; padding: 40px; color: #dc3545;">
                                  <h4>Network Error</h4>
                                  <p>Failed to connect to support system: ${error.message}</p>
                              </div>
                          `;
                      }
                  }
                  
                  // Load manage tickets
                  async function loadManageTickets() {
                      const container = document.getElementById('manageTicketsContent');
                      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Loading ticket management interface...</div>';
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets`);
                          
                          if (response.ok) {
                              const result = await response.json();
                              const tickets = result.tickets || [];
                              
                              if (tickets.length === 0) {
                                  container.innerHTML = `
                                      <div style="text-align: center; padding: 40px; color: #666;">
                                          <h4>No Tickets to Manage</h4>
                                          <p>No tickets have been created yet.</p>
                                      </div>
                                  `;
                              } else {
                                  let manageHtml = `
                                      <div style="margin-bottom: 20px;">
                                          <h4 style="margin: 0 0 15px 0; color: #333;">Ticket Management Actions</h4>
                                          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                              <button onclick="bulkUpdateStatus('closed')" style="
                                                  background: #dc3545; color: white; border: none; padding: 8px 16px; 
                                                  border-radius: 6px; font-size: 14px; cursor: pointer;
                                              ">Close All Open Tickets</button>
                                              <button onclick="bulkUpdateStatus('in_progress')" style="
                                                  background: #ffc107; color: #212529; border: none; padding: 8px 16px; 
                                                  border-radius: 6px; font-size: 14px; cursor: pointer;
                                              ">Mark All as In Progress</button>
                                              <button onclick="loadManageTickets()" style="
                                                  background: #6c757d; color: white; border: none; padding: 8px 16px; 
                                                  border-radius: 6px; font-size: 14px; cursor: pointer;
                                              ">Refresh</button>
                                          </div>
                                      </div>
                                      <div style="overflow-x: auto;">
                                          <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                              <thead>
                                                  <tr style="background: #f8f9fa;">
                                                      <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6;">Subject</th>
                                                      <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Priority</th>
                                                      <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Status</th>
                                                      <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Created</th>
                                                      <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">Actions</th>
                                                  </tr>
                                              </thead>
                                              <tbody>
                                  `;
                                  
                                  tickets.forEach(ticket => {
                                      const createdDate = new Date(ticket.created_at).toLocaleDateString();
                                      const statusColor = ticket.status === 'open' ? '#28a745' : 
                                                         ticket.status === 'in_progress' ? '#ffc107' : '#6c757d';
                                      const priorityColor = ticket.priority === 'sev1' ? '#dc3545' :
                                                           ticket.priority === 'high' ? '#fd7e14' :
                                                           ticket.priority === 'medium' ? '#ffc107' : '#28a745';
                                      
                                      manageHtml += `
                                          <tr style="border-bottom: 1px solid #dee2e6;">
                                              <td style="padding: 12px;">
                                                  <div style="font-weight: 600; margin-bottom: 4px;">${ticket.subject}</div>
                                                  <div style="font-size: 12px; color: #666;">ID: ${ticket.id.substring(0, 8)}...</div>
                                              </td>
                                              <td style="padding: 12px; text-align: center;">
                                                  <span style="
                                                      background: ${priorityColor}; color: white; padding: 4px 8px; 
                                                      border-radius: 12px; font-size: 12px; font-weight: 600;
                                                  ">${ticket.priority.toUpperCase()}</span>
                                              </td>
                                              <td style="padding: 12px; text-align: center;">
                                                  <span style="
                                                      background: ${statusColor}; color: white; padding: 4px 8px; 
                                                      border-radius: 12px; font-size: 12px; font-weight: 600;
                                                  ">${ticket.status.replace('_', ' ').toUpperCase()}</span>
                                              </td>
                                              <td style="padding: 12px; text-align: center; font-size: 12px;">${createdDate}</td>
                                              <td style="padding: 12px; text-align: center;">
                                                  <div style="display: flex; gap: 5px; justify-content: center;">
                                                      <button onclick="viewTicketDetails('${ticket.id}')" style="
                                                          background: #17a2b8; color: white; border: none; padding: 4px 8px; 
                                                          border-radius: 4px; font-size: 12px; cursor: pointer;
                                                      ">View</button>
                                                      <button onclick="updateTicketStatus('${ticket.id}', 'closed')" style="
                                                          background: #dc3545; color: white; border: none; padding: 4px 8px; 
                                                          border-radius: 4px; font-size: 12px; cursor: pointer;
                                                      ">Close</button>
                                                      <button onclick="deleteTicket('${ticket.id}')" style="
                                                          background: #6c757d; color: white; border: none; padding: 4px 8px; 
                                                          border-radius: 4px; font-size: 12px; cursor: pointer;
                                                      ">Delete</button>
                                                  </div>
                                              </td>
                                          </tr>
                                      `;
                                  });
                                  
                                  manageHtml += `
                                          </tbody>
                                      </table>
                                  </div>
                                  `;
                                  
                                  container.innerHTML = manageHtml;
                              }
                          } else {
                              const error = await response.json();
                              container.innerHTML = `
                                  <div style="text-align: center; padding: 40px; color: #dc3545;">
                                      <h4>Error Loading Tickets</h4>
                                      <p>${error.error || 'Failed to load tickets for management'}</p>
                                  </div>
                              `;
                          }
                      } catch (error) {
                          console.error('Error loading manage tickets:', error);
                          container.innerHTML = `
                              <div style="text-align: center; padding: 40px; color: #dc3545;">
                                  <h4>Network Error</h4>
                                  <p>Failed to connect to support system: ${error.message}</p>
                              </div>
                          `;
                      }
                  }
                  
                  // Delete ticket function
                  async function deleteTicket(ticketId) {
                      if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
                          return;
                      }
                      
                      try {
                          const response = await fetch(`${supportApiUrl}/tickets/${ticketId}`, {
                              method: 'DELETE',
                              headers: {
                                  'Content-Type': 'application/json',
                              }
                          });
                          
                          if (response.ok) {
                              // Reload manage tickets to show updated list
                              loadManageTickets();
                          } else {
                              const error = await response.json();
                              alert(`Failed to delete ticket: ${error.error || 'Unknown error'}`);
                          }
                      } catch (error) {
                          console.error('Error deleting ticket:', error);
                          alert(`Network error: ${error.message}`);
                      }
                  }
                  
                  // Bulk update status function
                  async function bulkUpdateStatus(newStatus) {
                      if (!confirm(`Are you sure you want to update all tickets to ${newStatus.replace('_', ' ')}?`)) {
                          return;
                      }
                      
                      try {
                          // Get all tickets first
                          const response = await fetch(`${supportApiUrl}/tickets`);
                          if (response.ok) {
                              const result = await response.json();
                              const tickets = result.tickets || [];
                              
                              // Update each ticket
                              let successCount = 0;
                              for (const ticket of tickets) {
                                  if (ticket.status !== newStatus) {
                                      try {
                                          const updateResponse = await fetch(`${supportApiUrl}/tickets/${ticket.id}`, {
                                              method: 'PUT',
                                              headers: {
                                                  'Content-Type': 'application/json',
                                              },
                                              body: JSON.stringify({
                                                  status: newStatus
                                              })
                                          });
                                          
                                          if (updateResponse.ok) {
                                              successCount++;
                                          }
                                      } catch (error) {
                                          console.error(`Error updating ticket ${ticket.id}:`, error);
                                      }
                                  }
                              }
                              
                              alert(`Successfully updated ${successCount} tickets to ${newStatus.replace('_', ' ')}`);
                              loadManageTickets(); // Reload the management interface
                          }
                      } catch (error) {
                          console.error('Error in bulk update:', error);
                          alert(`Network error: ${error.message}`);
                      }
                  }
                  
                  // Initialize support tickets when the page loads
                  document.addEventListener('DOMContentLoaded', () => {
                      initializeSupportTickets();
                  });

                  // Function to generate HTML from report data
                  function generateReportHTML(data) {
                      if (!data || !data.images) {
                          return '<p>No report data available.</p>';
                      }
                      
                      const serverInfo = data.server_info || {};
                      const generatedAt = data.generated_at ? new Date(data.generated_at).toLocaleString() : 'Unknown';
                      
                      let html = `
                          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                              <h3 style="margin: 0 0 15px 0; color: #333;">? Analytics Report</h3>
                              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                  <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                      <div style="font-size: 24px; font-weight: bold; color: #e60023;">${data.total_images || 0}</div>
                                      <div style="font-size: 14px; color: #666;">Total Images</div>
                                  </div>
                                  <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                      <div style="font-size: 24px; font-weight: bold; color: #28a745;">${data.total_likes || 0}</div>
                                      <div style="font-size: 14px; color: #666;">Total Likes</div>
                                  </div>
                                  <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                      <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${data.total_shares || 0}</div>
                                      <div style="font-size: 14px; color: #666;">Total Shares</div>
                                  </div>
                                  <div style="background: white; padding: 15px; border-radius: 6px; text-align: center;">
                                      <div style="font-size: 24px; font-weight: bold; color: #6f42c1;">${data.total_views || 0}</div>
                                      <div style="font-size: 14px; color: #666;">Total Views</div>
                                  </div>
                              </div>
                              <div style="font-size: 12px; color: #666;">
                                  <strong>Generated:</strong> ${generatedAt}<br>
                                  <strong>Source:</strong> ${data.source || 'Unknown'}<br>
                                  ${serverInfo.hostname ? `<strong>Server:</strong> ${serverInfo.hostname}<br>` : ''}
                                  ${serverInfo.server_time ? `<strong>Server Time:</strong> ${serverInfo.server_time}` : ''}
                              </div>
                          </div>
                      `;
                      
                      if (data.images && data.images.length > 0) {
                          html += `
                              <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                  <h4 style="margin: 0; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">Image Performance Details</h4>
                                  <div style="overflow-x: auto;">
                                      <table style="width: 100%; border-collapse: collapse;">
                                          <thead>
                                              <tr style="background: #f8f9fa;">
                                                  <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600;">Image</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Likes</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Shares</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Views</th>
                                                  <th style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6; font-weight: 600;">Score</th>
                                                  <th style="padding: 12px; text-align: left; border-bottom: 1px solid #dee2e6; font-weight: 600;">Last Updated</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                          `;
                          
                          data.images.forEach((image, index) => {
                              const totalInteractions = (image.likes_count || 0) + (image.shares_count || 0);
                              const popularityScore = totalInteractions > 0 ? (totalInteractions / 10).toFixed(1) : '0.0';
                              
                              let scoreColor = '#dc3545'; // red for low
                              if (totalInteractions >= 10) {
                                  scoreColor = '#28a745'; // green for high
                              } else if (totalInteractions >= 5) {
                                  scoreColor = '#ffc107'; // yellow for medium
                              }
                              
                              const lastUpdated = image.updated_at ? 
                                  new Date(image.updated_at).toLocaleString() : 
                                  'N/A';
                              
                              const rowBg = index % 2 === 0 ? '#ffffff' : '#f8f9fa';
                              
                              html += `
                                  <tr style="background: ${rowBg};">
                                      <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">${image.title}</td>
                                      <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${image.likes_count || 0}</td>
                                      <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${image.shares_count || 0}</td>
                                      <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">${image.views_count || 0}</td>
                                      <td style="padding: 12px; text-align: center; border-bottom: 1px solid #dee2e6;">
                                          <span style="color: ${scoreColor}; font-weight: bold;">${popularityScore}</span>
                                      </td>
                                      <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 12px;">${lastUpdated}</td>
                                  </tr>
                              `;
                          });
                          
                          html += `
                                          </tbody>
                                      </table>
                                  </div>
                              </div>
                          `;
                      } else {
                          html += `
                              <div style="background: white; padding: 20px; border-radius: 8px; text-align: center; color: #666;">
                                  <p>No image data available in the report.</p>
                              </div>
                          `;
                      }
                      
                      // Add interaction summary if available
                      if (data.interactions_summary && data.interactions_summary.length > 0) {
                          html += `
                              <div style="background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px;">
                                  <h4 style="margin: 0; padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6;">Recent Interactions Summary</h4>
                                  <div style="padding: 15px;">
                          `;
                          
                          data.interactions_summary.forEach(interaction => {
                              html += `
                                  <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f1f1f1;">
                                      <span>${interaction.action} (${interaction.date})</span>
                                      <span style="font-weight: bold;">${interaction.count}</span>
                                  </div>
                              `;
                          });
                          
                          html += `
                                  </div>
                              </div>
                          `;
                      }
                      
                      return html;
                  }
              </script>
          </body>
          </html>'''
                      
                      return {
                          'statusCode': 200,
                          'headers': {
                              'Content-Type': 'text/html',
                              'Cache-Control': 'no-cache'
                          },
                          'body': html_content
                      }
                  
                  # Add API endpoints for images, tickets, etc. (same as original but clean)
                  elif path == '/api/images':
                      # Return images from database
                      try:
                          conn = get_db_connection()
                          with conn.cursor() as cursor:
                              cursor.execute(f"USE {os.environ['DB_NAME']}")
                              cursor.execute("""
                                  SELECT id, title, description, image_url, width, height, 
                                         likes_count, shares_count, views_count, created_at
                                  FROM images 
                                  ORDER BY id
                              """)
                              
                              images = []
                              for row in cursor.fetchall():
                                  images.append({
                                      'id': row['id'],
                                      'title': row['title'],
                                      'description': row['description'],
                                      'image_url': row['image_url'],
                                      'width': row['width'],
                                      'height': row['height'],
                                      'likes_count': row['likes_count'],
                                      'shares_count': row['shares_count'],
                                      'views_count': row['views_count'],
                                      'created_at': row['created_at'].isoformat() if row['created_at'] else None
                                  })
                              
                              return {
                                  'statusCode': 200,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*',
                                      'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                                      'Access-Control-Allow-Headers': 'Content-Type'
                                  },
                                  'body': json.dumps(images)
                              }
                      except Exception as e:
                          print(f"Error getting images: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': json.dumps({'error': 'Failed to retrieve images'})
                          }
                  
                  elif path == '/api/support/gateway-url':
                      # Return the support ticket API Gateway URL
                      try:
                          import boto3
                          ssm = boto3.client('ssm')
                          response = ssm.get_parameter(Name='/examplecorp/support/api-gateway-url')
                          gateway_url = response['Parameter']['Value']
                          
                          return {
                              'statusCode': 200,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*',
                                  'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                                  'Access-Control-Allow-Headers': 'Content-Type'
                              },
                              'body': json.dumps({'gateway_url': gateway_url})
                          }
                      except Exception as e:
                          print(f"Error getting support gateway URL: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': json.dumps({'error': 'Failed to retrieve support gateway URL'})
                          }
                  
                  elif path == '/api/proxy' or path == '/api/analytics/report':
                      # Proxy endpoint to fetch analytics from reporting server
                      try:
                          import boto3
                          import urllib.request
                          import urllib.error
                          
                          print("Analytics report requested - attempting to fetch from reporting server...")
                          
                          # First try to fetch directly from reporting server using internal IP
                          try:
                              # Get the internal IP of the reporting server from environment variable
                              reporting_server_ip = os.environ.get('REPORTING_SERVER_IP', '10.1.2.100')  # Default to expected private IP
                              reporting_url = f'http://{reporting_server_ip}/analytics.php'
                              print(f"Connecting to reporting server at {reporting_url}")
                              request = urllib.request.Request(reporting_url)
                              request.add_header('User-Agent', 'Lambda-Analytics-Proxy/1.0')
                              request.add_header('Accept', 'application/json')
                              
                              with urllib.request.urlopen(request, timeout=15) as response:
                                  if response.status == 200:
                                      analytics_data = json.loads(response.read().decode('utf-8'))
                                      print("Successfully fetched analytics from reporting server")
                                      
                                      # Add proxy metadata
                                      analytics_data['proxy_info'] = {
                                          'fetched_via': 'lambda-proxy',
                                          'proxy_timestamp': datetime.now().isoformat(),
                                          'reporting_server_status': 'accessible'
                                      }
                                      
                                      return {
                                          'statusCode': 200,
                                          'headers': {
                                              'Content-Type': 'application/json',
                                              'Access-Control-Allow-Origin': '*',
                                              'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                                              'Access-Control-Allow-Headers': 'Content-Type',
                                              'Cache-Control': 'no-cache'
                                          },
                                          'body': json.dumps(analytics_data)
                                      }
                                  else:
                                      print(f"Reporting server returned HTTP {response.status}")
                                      raise Exception(f"HTTP {response.status}")
                          except Exception as fetch_error:
                              print(f"Failed to fetch from reporting server: {fetch_error}")
                              
                              # Log network connectivity information for troubleshooting
                              try:
                                  import socket
                                  reporting_ip = os.environ.get('REPORTING_SERVER_IP', '10.1.2.100')
                                  print(f"Attempting to test network connectivity to {reporting_ip}:80")
                                  
                                  # Test basic network connectivity
                                  sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                                  sock.settimeout(5)
                                  result = sock.connect_ex((reporting_ip, 80))
                                  sock.close()
                                  
                                  if result == 0:
                                      print(f"Network connectivity to {reporting_ip}:80 is working")
                                  else:
                                      print(f"Network connectivity to {reporting_ip}:80 failed with code {result}")
                              except Exception as network_test_error:
                                  print(f"Network connectivity test failed: {network_test_error}")
                              
                              # Fallback 1: try SSM parameter (if reporting server stored data there)
                              try:
                                  print("Trying SSM parameter fallback...")
                                  ssm = boto3.client('ssm')
                                  response = ssm.get_parameter(Name='/examplecorp/analytics/report')
                                  analytics_data = json.loads(response['Parameter']['Value'])
                                  print("Successfully retrieved analytics from SSM parameter")
                                  
                                  # Add fallback metadata
                                  analytics_data['proxy_info'] = {
                                      'fetched_via': 'ssm-fallback',
                                      'proxy_timestamp': datetime.now().isoformat(),
                                      'reporting_server_status': 'unavailable',
                                      'fallback_reason': str(fetch_error)
                                  }
                                  
                                  return {
                                      'statusCode': 200,
                                      'headers': {
                                          'Content-Type': 'application/json',
                                          'Access-Control-Allow-Origin': '*',
                                          'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                                          'Access-Control-Allow-Headers': 'Content-Type',
                                          'Cache-Control': 'no-cache'
                                      },
                                      'body': json.dumps(analytics_data)
                                  }
                              except Exception as ssm_error:
                                  print(f"SSM parameter also failed: {ssm_error}")
                                  
                                  # Fallback 2: generate from database directly
                                  print("Generating analytics from database as final fallback...")
                                  conn = get_db_connection()
                                  with conn.cursor() as cursor:
                                      cursor.execute(f"USE {os.environ['DB_NAME']}")
                                      cursor.execute("""
                                          SELECT id, title, description, image_url, width, height, 
                                                 likes_count, shares_count, views_count, created_at, updated_at
                                          FROM images 
                                          ORDER BY id
                                      """)
                                      
                                      images = []
                                      for row in cursor.fetchall():
                                          images.append({
                                              'id': row['id'],
                                              'title': row['title'],
                                              'description': row['description'],
                                              'image_url': row['image_url'],
                                              'width': row['width'],
                                              'height': row['height'],
                                              'likes_count': row['likes_count'],
                                              'shares_count': row['shares_count'],
                                              'views_count': row['views_count'],
                                              'created_at': row['created_at'].isoformat() if row['created_at'] else None,
                                              'updated_at': row['updated_at'].isoformat() if row['updated_at'] else None
                                          })
                                      
                                      # Calculate totals
                                      total_likes = sum(img['likes_count'] or 0 for img in images)
                                      total_shares = sum(img['shares_count'] or 0 for img in images)
                                      total_views = sum(img['views_count'] or 0 for img in images)
                                      
                                      analytics_data = {
                                          'images': images,
                                          'total_images': len(images),
                                          'total_likes': total_likes,
                                          'total_shares': total_shares,
                                          'total_views': total_views,
                                          'generated_at': datetime.now().isoformat(),
                                          'last_updated': datetime.now().isoformat(),
                                          'source': 'lambda-database-fallback',
                                          'proxy_info': {
                                              'fetched_via': 'database-fallback',
                                              'proxy_timestamp': datetime.now().isoformat(),
                                              'reporting_server_status': 'unavailable',
                                              'fallback_reason': f'Reporting server error: {fetch_error}, SSM error: {ssm_error}'
                                          },
                                          'server_info': {
                                              'hostname': 'lambda-proxy',
                                              'server_time': datetime.now().isoformat()
                                          }
                                      }
                                      
                                      return {
                                          'statusCode': 200,
                                          'headers': {
                                              'Content-Type': 'application/json',
                                              'Access-Control-Allow-Origin': '*',
                                              'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                                              'Access-Control-Allow-Headers': 'Content-Type',
                                              'Cache-Control': 'no-cache'
                                          },
                                          'body': json.dumps(analytics_data)
                                      }
                      except Exception as e:
                          print(f"Error in analytics proxy endpoint: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': json.dumps({
                                  'error': f'Analytics proxy failed: {str(e)}',
                                  'proxy_info': {
                                      'fetched_via': 'error',
                                      'proxy_timestamp': datetime.now().isoformat(),
                                      'reporting_server_status': 'unknown'
                                  }
                              })
                          }
                  
                  else:
                      return {
                          'statusCode': 404,
                          'headers': {'Content-Type': 'text/plain'},
                          'body': f'Not found: {path}'
                      }
              
              except Exception as e:
                  print(f"HTML Renderer Lambda error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({'error': f'Internal server error: {str(e)}'})
                  }

  # ==========================================
  # LAMBDA 2: IMAGE PROCESSING AND S3 UPLOAD
  # ==========================================
  ImageProcessingFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: sample-app-image-processor
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref AppPrivateSubnet1
          - !Ref AppPrivateSubnet2
      Environment:
        Variables:
          S3_BUCKET: !Ref ImageBucket
      Code:
        ZipFile: |
          import json
          import boto3
          import os
          from botocore.exceptions import ClientError
          import base64
          
          s3_client = boto3.client('s3')
          
          def lambda_handler(event, context):
              try:
                  path = event.get('path', '/')
                  method = event.get('httpMethod', 'GET')
                  
                  print(f"Image Processor Request: {method} {path}")
                  
                  if path.startswith('/images/'):
                      s3_key = path[1:]
                      try:
                          print(f"Attempting to serve image: {s3_key} from bucket: {os.environ['S3_BUCKET']}")
                          
                          response = s3_client.get_object(Bucket=os.environ['S3_BUCKET'], Key=s3_key)
                          image_content = response['Body'].read()
                          
                          content_type = 'image/jpeg'
                          if s3_key.lower().endswith('.png'):
                              content_type = 'image/png'
                          elif s3_key.lower().endswith('.gif'):
                              content_type = 'image/gif'
                          elif s3_key.lower().endswith('.webp'):
                              content_type = 'image/webp'
                          elif s3_key.lower().endswith('.svg'):
                              content_type = 'image/svg+xml'
                          
                          print(f"Successfully retrieved image {s3_key}, size: {len(image_content)} bytes, content-type: {content_type}")
                          
                          return {
                              'statusCode': 200,
                              'headers': {
                                  'Content-Type': content_type,
                                  'Cache-Control': 'public, max-age=3600',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': base64.b64encode(image_content).decode('utf-8'),
                              'isBase64Encoded': True
                          }
                      except ClientError as e:
                          print(f"S3 ClientError serving image {s3_key}: {e}")
                          return {
                              'statusCode': 404,
                              'headers': {
                                  'Content-Type': 'text/plain',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': f'Image not found: {s3_key}'
                          }
                      except Exception as e:
                          print(f"Unexpected error serving image {s3_key}: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'text/plain',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': f'Error serving image: {str(e)}'
                          }
                  
                  else:
                      return {
                          'statusCode': 404,
                          'headers': {'Content-Type': 'text/plain'},
                          'body': f'Not found: {path}'
                      }
              
              except Exception as e:
                  print(f"Image Processor Lambda error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({'error': f'Internal server error: {str(e)}'})
                  }

  # ==========================================
  # LAMBDA 3: USER INTERACTIONS AND DATABASE UPDATES
  # Flow: User clicks like/share ? User Interaction Lambda ? Database update
  # ==========================================
  UserInteractionFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: sample-app-user-interactions
      Runtime: python3.9
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRole.Arn
      Timeout: 30
      Layers:
        - !Ref PyMySQLLayer
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref AppPrivateSubnet1
          - !Ref AppPrivateSubnet2
      Environment:
        Variables:
          DB_HOST: !GetAtt ImageMetadataDatabase.Endpoint.Address
          DB_USER: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_NAME: image_metadata
          FLOW_DESCRIPTION: "User clicks like/share ? User Interaction Lambda ? Database update"
      Code:
        ZipFile: |
          import json
          import os
          from datetime import datetime
          
          import pymysql
          
          db_connection = None
          
          def get_db_connection():
              global db_connection
              
              if db_connection is None or not db_connection.open:
                  try:
                      db_connection = pymysql.connect(
                          host=os.environ['DB_HOST'],
                          user=os.environ['DB_USER'],
                          password=os.environ['DB_PASSWORD'],
                          database=os.environ['DB_NAME'],
                          charset='utf8mb4',
                          cursorclass=pymysql.cursors.DictCursor,
                          autocommit=True
                      )
                      print("Database connection established")
                  except Exception as e:
                      print(f"Database connection error: {e}")
                      try:
                          db_connection = pymysql.connect(
                              host=os.environ['DB_HOST'],
                              user=os.environ['DB_USER'],
                              password=os.environ['DB_PASSWORD'],
                              charset='utf8mb4',
                              cursorclass=pymysql.cursors.DictCursor,
                              autocommit=True
                          )
                          print("Database connection established without database name")
                      except Exception as e2:
                          print(f"Fallback database connection error: {e2}")
                          raise Exception("Failed to establish database connection")
              
              return db_connection
          
          def track_interaction_db(image_id, action, session_id=None):
              try:
                  image_id = int(image_id)
                  conn = get_db_connection()
                  
                  with conn.cursor() as cursor:
                      cursor.execute(f"USE {os.environ['DB_NAME']}")
                      
                      cursor.execute("""
                          INSERT INTO image_interactions (image_id, action, session_id, created_at)
                          VALUES (%s, %s, %s, NOW())
                      """, (image_id, action, session_id))
                      
                      if action == 'like':
                          cursor.execute("""
                              UPDATE images 
                              SET likes_count = likes_count + 1, updated_at = NOW()
                              WHERE id = %s
                          """, (image_id,))
                      elif action == 'share':
                          cursor.execute("""
                              UPDATE images 
                              SET shares_count = shares_count + 1, updated_at = NOW()
                              WHERE id = %s
                          """, (image_id,))
                      elif action == 'view':
                          cursor.execute("""
                              UPDATE images 
                              SET views_count = views_count + 1, updated_at = NOW()
                              WHERE id = %s
                          """, (image_id,))
                      
                      cursor.execute("""
                          SELECT likes_count, shares_count, views_count 
                          FROM images 
                          WHERE id = %s
                      """, (image_id,))
                      
                      result = cursor.fetchone()
                      if result:
                          print(f"Tracked {action} for image {image_id}. New counts: likes={result['likes_count']}, shares={result['shares_count']}, views={result['views_count']}")
                      
                      return True
                      
              except Exception as e:
                  print(f"Error tracking interaction in database: {e}")
                  raise Exception(f"Failed to track {action} interaction in database: {e}")
          
          def lambda_handler(event, context):
              try:
                  path = event.get('path', '/')
                  method = event.get('httpMethod', 'GET')
                  
                  print(f"User Interaction Request: {method} {path}")
                  
                  if path == '/api/track/like' and method == 'POST':
                      try:
                          body = event.get('body', '{}')
                          if event.get('isBase64Encoded', False):
                              import base64
                              body = base64.b64decode(body).decode('utf-8')
                          
                          data = json.loads(body)
                          image_id = data.get('imageId')
                          session_id = data.get('sessionId')
                          
                          if not image_id:
                              return {
                                  'statusCode': 400,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'error': 'imageId is required'})
                              }
                          
                          success = track_interaction_db(image_id, 'like', session_id)
                          
                          if success:
                              return {
                                  'statusCode': 200,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'status': 'success', 'action': 'like', 'imageId': image_id})
                              }
                          else:
                              return {
                                  'statusCode': 500,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'error': 'Failed to track like'})
                              }
                      except Exception as e:
                          print(f"Error tracking like: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': json.dumps({'error': 'Internal server error'})
                          }
                  
                  elif path == '/api/track/share' and method == 'POST':
                      try:
                          body = event.get('body', '{}')
                          if event.get('isBase64Encoded', False):
                              import base64
                              body = base64.b64decode(body).decode('utf-8')
                          
                          data = json.loads(body)
                          image_id = data.get('imageId')
                          session_id = data.get('sessionId')
                          
                          if not image_id:
                              return {
                                  'statusCode': 400,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'error': 'imageId is required'})
                              }
                          
                          success = track_interaction_db(image_id, 'share', session_id)
                          
                          if success:
                              return {
                                  'statusCode': 200,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'status': 'success', 'action': 'share', 'imageId': image_id})
                              }
                          else:
                              return {
                                  'statusCode': 500,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'error': 'Failed to track share'})
                              }
                      except Exception as e:
                          print(f"Error tracking share: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': json.dumps({'error': 'Internal server error'})
                          }
                  
                  elif path == '/api/track/view' and method == 'POST':
                      try:
                          body = event.get('body', '{}')
                          if event.get('isBase64Encoded', False):
                              import base64
                              body = base64.b64decode(body).decode('utf-8')
                          
                          data = json.loads(body)
                          image_id = data.get('imageId')
                          session_id = data.get('sessionId')
                          
                          if not image_id:
                              return {
                                  'statusCode': 400,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'error': 'imageId is required'})
                              }
                          
                          success = track_interaction_db(image_id, 'view', session_id)
                          
                          if success:
                              return {
                                  'statusCode': 200,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'status': 'success', 'action': 'view', 'imageId': image_id})
                              }
                          else:
                              return {
                                  'statusCode': 500,
                                  'headers': {
                                      'Content-Type': 'application/json',
                                      'Access-Control-Allow-Origin': '*'
                                  },
                                  'body': json.dumps({'error': 'Failed to track view'})
                              }
                      except Exception as e:
                          print(f"Error tracking view: {e}")
                          return {
                              'statusCode': 500,
                              'headers': {
                                  'Content-Type': 'application/json',
                                  'Access-Control-Allow-Origin': '*'
                              },
                              'body': json.dumps({'error': 'Internal server error'})
                          }
                  
                  elif method == 'OPTIONS':
                      return {
                          'statusCode': 200,
                          'headers': {
                              'Access-Control-Allow-Origin': '*',
                              'Access-Control-Allow-Methods': 'GET, POST, OPTIONS',
                              'Access-Control-Allow-Headers': 'Content-Type'
                          },
                          'body': ''
                      }
                  
                  else:
                      return {
                          'statusCode': 404,
                          'headers': {'Content-Type': 'text/plain'},
                          'body': f'Not found: {path}'
                      }
              
              except Exception as e:
                  print(f"User Interaction Lambda error: {str(e)}")
                  return {
                      'statusCode': 500,
                      'headers': {
                          'Content-Type': 'application/json',
                          'Access-Control-Allow-Origin': '*'
                      },
                      'body': json.dumps({'error': f'Internal server error: {str(e)}'})
                  }

  # ==========================================
  # APPLICATION LOAD BALANCER
  # ==========================================
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: sample-app-ALB
      Scheme: internet-facing
      Type: application
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref AppPublicSubnet1
        - !Ref AppPublicSubnet2
      Tags:
        - Key: Name
          Value: sample-app-ApplicationLoadBalancer

  # Target Groups for Lambda Functions
  HTMLRenderingTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-app-html-rendering-tg
      TargetType: lambda
      Targets:
        - Id: !GetAtt HTMLRenderingFunction.Arn
      HealthCheckEnabled: false
      Tags:
        - Key: Name
          Value: sample-app-HTMLRenderingTargetGroup

  ImageProcessingTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-app-image-processing-tg
      TargetType: lambda
      Targets:
        - Id: !GetAtt ImageProcessingFunction.Arn
      HealthCheckEnabled: false
      Tags:
        - Key: Name
          Value: sample-app-ImageProcessingTargetGroup

  UserInteractionTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: sample-app-user-interaction-tg
      TargetType: lambda
      Targets:
        - Id: !GetAtt UserInteractionFunction.Arn
      HealthCheckEnabled: false
      Tags:
        - Key: Name
          Value: sample-app-UserInteractionTargetGroup

  # Lambda Permissions for ALB
  HTMLRenderingLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref HTMLRenderingFunction
      Action: lambda:InvokeFunction
      Principal: elasticloadbalancing.amazonaws.com
      SourceArn: !Sub "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/sample-app-html-rendering-tg/*"

  ImageProcessingLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref ImageProcessingFunction
      Action: lambda:InvokeFunction
      Principal: elasticloadbalancing.amazonaws.com
      SourceArn: !Sub "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/sample-app-image-processing-tg/*"

  UserInteractionLambdaPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref UserInteractionFunction
      Action: lambda:InvokeFunction
      Principal: elasticloadbalancing.amazonaws.com
      SourceArn: !Sub "arn:aws:elasticloadbalancing:${AWS::Region}:${AWS::AccountId}:targetgroup/sample-app-user-interaction-tg/*"

  # ALB Listener
  ALBListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref HTMLRenderingTargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  # Listener Rules for routing
  ImageProcessingListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref ImageProcessingTargetGroup
      Conditions:
        - Field: path-pattern
          Values:
            - "/images/*"
      ListenerArn: !Ref ALBListener
      Priority: 100

  UserInteractionListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref UserInteractionTargetGroup
      Conditions:
        - Field: path-pattern
          Values:
            - "/api/track/*"
      ListenerArn: !Ref ALBListener
      Priority: 200

  AnalyticsProxyListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref HTMLRenderingTargetGroup
      Conditions:
        - Field: path-pattern
          Values:
            - "/api/proxy"
            - "/api/analytics/*"
      ListenerArn: !Ref ALBListener
      Priority: 150

  # Additional listener rule specifically for /api/proxy endpoint (redundant but explicit)
  ProxyEndpointListenerRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: forward
          TargetGroupArn: !Ref HTMLRenderingTargetGroup
      Conditions:
        - Field: path-pattern
          Values:
            - "/api/proxy"
      ListenerArn: !Ref ALBListener
      Priority: 140

  # ==========================================
  # ROUTE 53 PRIVATE HOSTED ZONE
  # ==========================================
  ExampleCorpPrivateHostedZone:
    Type: AWS::Route53::HostedZone
    Properties:
      Name: examplecorp.com
      VPCs:
        - VPCId: !Ref AppVPC
          VPCRegion: !Ref AWS::Region
        - VPCId: !Ref ReportingVPC
          VPCRegion: !Ref AWS::Region
      HostedZoneConfig:
        Comment: Private hosted zone for ExampleCorp.com internal services
      HostedZoneTags:
        - Key: Name
          Value: examplecorp.com-private-zone

  # DNS Records
  AppALBRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref ExampleCorpPrivateHostedZone
      Name: app.examplecorp.com
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID

  DatabaseDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref ExampleCorpPrivateHostedZone
      Name: database.examplecorp.com
      Type: CNAME
      TTL: 300
      ResourceRecords:
        - !GetAtt ImageMetadataDatabase.Endpoint.Address

  ReportingServerDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref ExampleCorpPrivateHostedZone
      Name: reporting.examplecorp.com
      Type: A
      TTL: 300
      ResourceRecords:
        - !GetAtt ReportingEC2Instance.PrivateIp

  BastionDNSRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneId: !Ref ExampleCorpPrivateHostedZone
      Name: bastion.examplecorp.com
      Type: A
      TTL: 300
      ResourceRecords:
        - !GetAtt BastionEC2Instance.PrivateIp

  # ==========================================
  # REPORTING EC2 INSTANCE
  # ==========================================
  ReportingEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/al2023-ami-kernel-6.1-x86_64}}'
      InstanceType: t3.small
      SubnetId: !Ref ReportingPrivateSubnet
      SecurityGroupIds:
        - !Ref ReportingServerSecurityGroup
      IamInstanceProfile: !Ref ReportingServerInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          
          # Update system and install packages
          yum update -y
          yum install -y httpd php php-mysqlnd mysql awscli
          
          # Configure and start Apache
          systemctl enable httpd
          systemctl start httpd
          
          # Set up web directory permissions
          chown -R apache:apache /var/www/html
          chmod -R 755 /var/www/html
          
          # Get database connection details
          DB_HOST="${ImageMetadataDatabase.Endpoint.Address}"
          DB_USER="${DBUsername}"
          DB_PASSWORD="${DBPassword}"
          DB_NAME="image_metadata"
          
          # Create analytics API endpoint
          echo "=== CREATING ANALYTICS API ==="
          cat > /var/www/html/analytics.php << 'EOF'
          <?php
          header('Content-Type: application/json');
          header('Access-Control-Allow-Origin: *');
          header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
          header('Access-Control-Allow-Headers: Content-Type');
          
          // Handle preflight OPTIONS request - check if REQUEST_METHOD is set
          if (isset($_SERVER['REQUEST_METHOD']) && $_SERVER['REQUEST_METHOD'] == 'OPTIONS') {
              http_response_code(200);
              exit();
          }
          
          // Database configuration - will be replaced by actual values
          $db_host = getenv('DB_HOST') ? getenv('DB_HOST') : 'DB_HOST_PLACEHOLDER';
          $db_user = getenv('DB_USER') ? getenv('DB_USER') : 'DB_USER_PLACEHOLDER';
          $db_password = getenv('DB_PASSWORD') ? getenv('DB_PASSWORD') : 'DB_PASSWORD_PLACEHOLDER';
          $db_name = getenv('DB_NAME') ? getenv('DB_NAME') : 'DB_NAME_PLACEHOLDER';
          
          try {
              // Connect to database with PHP 5.4 compatible array syntax
              $options = array(
                  PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8 COLLATE utf8_general_ci",
                  PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                  PDO::MYSQL_ATTR_USE_BUFFERED_QUERY => true,
                  PDO::ATTR_TIMEOUT => 30
              );
              
              $dsn = "mysql:host=$db_host;dbname=$db_name;charset=utf8";
              $pdo = new PDO($dsn, $db_user, $db_password, $options);
              
              // Additional compatibility settings for MySQL 8.0 with PHP 5.4
              $pdo->exec("SET SESSION sql_mode = 'TRADITIONAL'");
              $pdo->exec("SET SESSION character_set_client = 'utf8'");
              $pdo->exec("SET SESSION character_set_results = 'utf8'");
              $pdo->exec("SET SESSION character_set_connection = 'utf8'");
              
              // Get images with interaction counts
              $stmt = $pdo->prepare("
                  SELECT 
                      id, title, description, image_url, width, height,
                      likes_count, shares_count, views_count, 
                      created_at, updated_at
                  FROM images 
                  ORDER BY id
              ");
              $stmt->execute();
              $images = $stmt->fetchAll(PDO::FETCH_ASSOC);
              
              // Get interaction summary
              $stmt = $pdo->prepare("
                  SELECT 
                      action,
                      COUNT(*) as count,
                      DATE(created_at) as date
                  FROM image_interactions 
                  GROUP BY action, DATE(created_at)
                  ORDER BY date DESC, action
              ");
              $stmt->execute();
              $interactions_summary = $stmt->fetchAll(PDO::FETCH_ASSOC);
              
              // Calculate totals manually (PHP 5.4 compatible - no array_column)
              $total_likes = 0;
              $total_shares = 0;
              $total_views = 0;
              foreach ($images as $image) {
                  $total_likes += intval($image['likes_count']);
                  $total_shares += intval($image['shares_count']);
                  $total_views += intval($image['views_count']);
              }
              $total_images = count($images);
              
              // Prepare response with PHP 5.4 compatible array syntax
              $response = array(
                  'images' => $images,
                  'interactions_summary' => $interactions_summary,
                  'total_images' => $total_images,
                  'total_likes' => $total_likes,
                  'total_shares' => $total_shares,
                  'total_views' => $total_views,
                  'generated_at' => date('c'),
                  'last_updated' => date('c'),
                  'source' => 'reporting-server',
                  'server_info' => array(
                      'hostname' => gethostname(),
                      'php_version' => phpversion(),
                      'server_time' => date('Y-m-d H:i:s T')
                  )
              );
              
              // Store in SSM Parameter for Lambda to access
              try {
                  $aws_region = file_get_contents('http://169.254.169.254/latest/meta-data/placement/region');
                  $ssm_command = "aws ssm put-parameter --region $aws_region --name '/examplecorp/analytics/report' --value '" . json_encode($response) . "' --type String --overwrite";
                  exec($ssm_command, $output, $return_code);
                  
                  if ($return_code === 0) {
                      $response['ssm_update'] = 'success';
                  } else {
                      $response['ssm_update'] = 'failed';
                      $response['ssm_error'] = implode("\n", $output);
                  }
              } catch (Exception $e) {
                  $response['ssm_update'] = 'error';
                  $response['ssm_error'] = $e->getMessage();
              }
              
              echo json_encode($response);
              
          } catch (PDOException $e) {
              http_response_code(500);
              echo json_encode(array(
                  'error' => 'Database connection failed',
                  'message' => $e->getMessage(),
                  'server_info' => array(
                      'hostname' => gethostname(),
                      'php_version' => phpversion(),
                      'server_time' => date('Y-m-d H:i:s T')
                  )
              ));
          } catch (Exception $e) {
              http_response_code(500);
              echo json_encode(array(
                  'error' => 'Internal server error',
                  'message' => $e->getMessage(),
                  'server_info' => array(
                      'hostname' => gethostname(),
                      'php_version' => phpversion(),
                      'server_time' => date('Y-m-d H:i:s T')
                  )
              ));
          }
          ?>
          EOF
          
          # Replace placeholders with actual values - escape special characters for sed
          DB_HOST_ESCAPED=$(echo "$DB_HOST" | sed 's/[[\.*^$()+?{|]/\\&/g')
          DB_USER_ESCAPED=$(echo "$DB_USER" | sed 's/[[\.*^$()+?{|]/\\&/g')
          DB_PASSWORD_ESCAPED=$(echo "$DB_PASSWORD" | sed 's/[[\.*^$()+?{|]/\\&/g')
          DB_NAME_ESCAPED=$(echo "$DB_NAME" | sed 's/[[\.*^$()+?{|]/\\&/g')
          
          sed -i "s/DB_HOST_PLACEHOLDER/$DB_HOST_ESCAPED/g" /var/www/html/analytics.php
          sed -i "s/DB_USER_PLACEHOLDER/$DB_USER_ESCAPED/g" /var/www/html/analytics.php
          sed -i "s/DB_PASSWORD_PLACEHOLDER/$DB_PASSWORD_ESCAPED/g" /var/www/html/analytics.php
          sed -i "s/DB_NAME_PLACEHOLDER/$DB_NAME_ESCAPED/g" /var/www/html/analytics.php
          
          # Create main index page
          echo "=== CREATING MAIN INDEX PAGE ==="
          cat > /var/www/html/index.php << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>ExampleCorp Reporting Server</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
                  h1 { color: #e60023; }
                  .status { background: #d4edda; padding: 15px; border-radius: 5px; color: #155724; margin: 20px 0; }
                  .links a { display: inline-block; margin: 10px 15px 10px 0; padding: 10px 20px; background: #e60023; color: white; text-decoration: none; border-radius: 5px; }
                  .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ExampleCorp Reporting Server</h1>
                  <div class="status">
                      <strong>Server Status:</strong> Online and Ready<br>
                      <strong>Server Time:</strong> <?php echo date('Y-m-d H:i:s T'); ?><br>
                      <strong>Hostname:</strong> <?php echo gethostname(); ?>
                  </div>
                  
                  <?php
                  // Test database connection
                  try {
                      $db_host = 'DB_HOST_PLACEHOLDER';
                      $db_user = 'DB_USER_PLACEHOLDER';
                      $db_password = 'DB_PASSWORD_PLACEHOLDER';
                      $db_name = 'DB_NAME_PLACEHOLDER';
                      
                      $pdo = new PDO("mysql:host=$db_host;dbname=$db_name;charset=utf8", $db_user, $db_password, [
                          PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8",
                          PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
                      ]);
                      
                      $stmt = $pdo->query("SELECT COUNT(*) as count FROM images");
                      $result = $stmt->fetch(PDO::FETCH_ASSOC);
                      
                      echo '<div class="status">';
                      echo '<strong>Database Connection:</strong> Successful<br>';
                      echo '<strong>Images in Database:</strong> ' . $result['count'] . '<br>';
                      echo '<strong>Database Host:</strong> ' . htmlspecialchars($db_host);
                      echo '</div>';
                      
                  } catch (Exception $e) {
                      echo '<div class="error">';
                      echo '<strong>Database Connection:</strong> Failed<br>';
                      echo '<strong>Error:</strong> ' . htmlspecialchars($e->getMessage());
                      echo '</div>';
                  }
                  ?>
                  
                  <div class="links">
                      <a href="/analytics.php">Analytics API</a>
                      <a href="/test.html">Server Test</a>
                  </div>
              </div>
          </body>
          </html>
          EOF
          
          # Replace placeholders in index.php as well
          sed -i "s/DB_HOST_PLACEHOLDER/$DB_HOST_ESCAPED/g" /var/www/html/index.php
          sed -i "s/DB_USER_PLACEHOLDER/$DB_USER_ESCAPED/g" /var/www/html/index.php
          sed -i "s/DB_PASSWORD_PLACEHOLDER/$DB_PASSWORD_ESCAPED/g" /var/www/html/index.php
          sed -i "s/DB_NAME_PLACEHOLDER/$DB_NAME_ESCAPED/g" /var/www/html/index.php
          
          # Create PHP info page
          cat > /var/www/html/phpinfo.php << 'EOF'
          <?php
          echo "<h1>ExampleCorp Reporting Server - PHP Configuration</h1>";
          echo "<p><strong>Server Time:</strong> " . date('Y-m-d H:i:s T') . "</p>";
          echo "<p><strong>Hostname:</strong> " . gethostname() . "</p>";
          echo "<hr>";
          phpinfo();
          ?>
          EOF
          
          # Create simple HTML test page
          cat > /var/www/html/test.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <title>ExampleCorp Reporting Server Test</title>
              <style>
                  body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                  .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #e60023; }
                  .success { background: #d4edda; padding: 15px; border-radius: 5px; color: #155724; margin: 20px 0; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ExampleCorp Reporting Server Test</h1>
                  <div class="success">
                      <strong>Test Result:</strong> Apache and PHP are working correctly!
                  </div>
                  <p><strong>Server Features:</strong></p>
                  <ul>
                      <li>Apache HTTP Server</li>
                      <li>PHP Runtime</li>
                      <li>MySQL Client</li>
                      <li>Analytics API</li>
                  </ul>
                  <p><a href="/">Back to Main Page</a></p>
              </div>
          </body>
          </html>
          EOF
          
          # Set proper file ownership and permissions
          chown -R apache:apache /var/www/html/
          chmod -R 644 /var/www/html/*
          chmod 755 /var/www/html/
          
          echo "Reporting server setup complete"
      Tags:
        - Key: Name
          Value: RIV-Reporting-Instance

  # ==========================================
  # CLOUDWATCH LOG GROUPS
  # ==========================================
  HTMLRenderingLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/sample-app-html-renderer-${AWS::StackName}"
      RetentionInDays: 14

  ImageProcessingLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/sample-app-image-processor"
      RetentionInDays: 14

  UserInteractionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/sample-app-user-interactions"
      RetentionInDays: 14

  ReportingServerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/ec2/reporting-server"
      RetentionInDays: 14

  CreatePyMySQLLayerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/sample-app-create-pymysql-layer"
      RetentionInDays: 7

  UploadContentLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: "/aws/lambda/sample-app-upload-content"
      RetentionInDays: 7

  # ==========================================
  # VPC 플로우 로그
  # VPC FLOW LOGS
  # ==========================================
  AppVPCLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: app-vpc-log-group
      RetentionInDays: 14

  ReportingVPCLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: reporting-vpc-log-group
      RetentionInDays: 14

  VPCFlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: VPCFlowLogsDeliveryRolePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                Resource: '*'

  AppVPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref AppVPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref AppVPCLogGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
      LogFormat: '${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}'
      Tags:
        - Key: Name
          Value: sample-app-App-VPC-FlowLog

  ReportingVPCFlowLog:
    Type: AWS::EC2::FlowLog
    Properties:
      ResourceType: VPC
      ResourceId: !Ref ReportingVPC
      TrafficType: ALL
      LogDestinationType: cloud-watch-logs
      LogGroupName: !Ref ReportingVPCLogGroup
      DeliverLogsPermissionArn: !GetAtt VPCFlowLogsRole.Arn
      LogFormat: '${version} ${account-id} ${interface-id} ${srcaddr} ${dstaddr} ${srcport} ${dstport} ${protocol} ${packets} ${bytes} ${start} ${end} ${action} ${log-status}'
      Tags:
        - Key: Name
          Value: sample-app-Reporting-VPC-FlowLog



# ==========================================
# 출력값
# OUTPUTS
# ==========================================
Outputs:
  ApplicationURL:
    Description: URL of the ExampleCorp Image Gallery application
    Value: !Sub "http://${ApplicationLoadBalancer.DNSName}"
    Export:
      Name: !Sub "${AWS::StackName}-ApplicationURL"

  PrivateApplicationURL:
    Description: Private DNS URL for the application (accessible from within VPCs)
    Value: "http://app.examplecorp.internal"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateApplicationURL"

  DatabaseEndpoint:
    Description: RDS Database endpoint
    Value: !GetAtt ImageMetadataDatabase.Endpoint.Address
    Export:
      Name: !Sub "${AWS::StackName}-DatabaseEndpoint"

  PrivateDatabaseURL:
    Description: Private DNS URL for the database
    Value: "db.examplecorp.internal"
    Export:
      Name: !Sub "${AWS::StackName}-PrivateDatabaseURL"

  S3BucketName:
    Description: S3 bucket for image storage
    Value: !Ref ImageBucket
    Export:
      Name: !Sub "${AWS::StackName}-S3BucketName"

  AppVPCId:
    Description: VPC ID for the application
    Value: !Ref AppVPC
    Export:
      Name: !Sub "${AWS::StackName}-AppVPCId"

  ReportingVPCId:
    Description: VPC ID for the reporting infrastructure
    Value: !Ref ReportingVPC
    Export:
      Name: !Sub "${AWS::StackName}-ReportingVPCId"

  TransitGatewayId:
    Description: Transit Gateway ID connecting the VPCs
    Value: !Ref TransitGateway
    Export:
      Name: !Sub "${AWS::StackName}-TransitGatewayId"

  BastionInstanceId:
    Description: Bastion EC2 instance ID in App VPC
    Value: !Ref BastionEC2Instance
    Export:
      Name: !Sub "${AWS::StackName}-BastionInstanceId"

  ReportingInstanceId:
    Description: Reporting EC2 instance ID in Reporting VPC
    Value: !Ref ReportingEC2Instance
    Export:
      Name: !Sub "${AWS::StackName}-ReportingInstanceId"

  HTMLRenderingFunctionArn:
    Description: ARN of the HTML Rendering Lambda function
    Value: !GetAtt HTMLRenderingFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-HTMLRenderingFunctionArn"

  ImageProcessingFunctionArn:
    Description: ARN of the Image Processing Lambda function
    Value: !GetAtt ImageProcessingFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-ImageProcessingFunctionArn"

  UserInteractionFunctionArn:
    Description: ARN of the User Interaction Lambda function
    Value: !GetAtt UserInteractionFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-UserInteractionFunctionArn"

  PrivateHostedZoneId:
    Description: Route 53 Private Hosted Zone ID
    Value: !Ref ExampleCorpPrivateHostedZone
    Export:
      Name: !Sub "${AWS::StackName}-PrivateHostedZoneId"

  SupportTicketApiGatewayURL:
    Description: Support Ticket API Gateway URL
    Value: !Sub "https://${SupportTicketApiGateway}.execute-api.${AWS::Region}.amazonaws.com/prod"
    Export:
      Name: !Sub "${AWS::StackName}-SupportTicketApiGatewayURL"

  SupportTicketFunctionArn:
    Description: ARN of the Support Ticket Lambda function
    Value: !GetAtt SupportTicketFunction.Arn
    Export:
      Name: !Sub "${AWS::StackName}-SupportTicketFunctionArn"
